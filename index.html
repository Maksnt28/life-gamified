<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Life Gamified</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            background: #0a0a0a;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            color: #e5e5e5;
            padding: 1rem;
            padding-bottom: 5rem;
            overflow-x: hidden;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 1rem;
        }

        .app-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 0.25rem;
            letter-spacing: -0.02em;
        }

        .app-subtitle {
            color: #525252;
            font-size: 0.8rem;
            font-weight: 400;
        }

        /* Level Progress */
        .level-container {
            margin-top: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .level-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.8rem;
            color: #737373;
        }

        .level-badge {
            color: #a3a3a3;
            font-weight: 500;
        }

        .level-badge span {
            color: #ffffff;
            font-weight: 600;
        }

        .xp-text {
            color: #525252;
        }

        .progress-bar-container {
            width: 200px;
            height: 4px;
            background: #1a1a1a;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #60a5fa);
            border-radius: 2px;
            transition: width 0.3s ease;
            width: 0%;
        }

        /* Date Navigation */
        .date-nav {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin: 1rem 0;
        }

        .nav-arrow {
            width: 36px;
            height: 36px;
            background: #141414;
            border: 1px solid #262626;
            border-radius: 8px;
            color: #737373;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media (hover: hover) {
            .nav-arrow:hover {
                border-color: #404040;
                color: #a3a3a3;
            }
        }

        .date-display {
            font-size: 1rem;
            font-weight: 500;
            color: #e5e5e5;
            min-width: 180px;
            text-align: center;
        }

        .today-btn {
            padding: 0.5rem 0.75rem;
            background: #141414;
            border: 1px solid #262626;
            border-radius: 8px;
            color: #737373;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        @media (hover: hover) {
            .today-btn:hover {
                border-color: #404040;
                color: #a3a3a3;
            }
        }

        .today-btn.active {
            background: #3b82f6;
            border-color: #3b82f6;
            color: #ffffff;
        }

        /* View Toggle */
        .view-toggle-container {
            display: flex;
            justify-content: center;
            margin-bottom: 1rem;
        }

        .view-toggle {
            display: flex;
            background: #141414;
            border: 1px solid #262626;
            border-radius: 8px;
            padding: 4px;
            gap: 2px;
        }

        .view-btn {
            padding: 0.5rem 1rem;
            border: none;
            background: transparent;
            color: #525252;
            font-size: 0.8rem;
            font-weight: 500;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        @media (hover: hover) {
            .view-btn:hover {
                color: #737373;
            }
        }

        .view-btn.active {
            background: #262626;
            color: #e5e5e5;
        }

        /* Day View */
        .day-view-container {
            display: none;
        }

        .day-view-container.active {
            display: block;
        }

        .day-content {
            background: #0f0f0f;
            border: 1px solid #1a1a1a;
            border-radius: 12px;
            padding: 1rem;
            min-height: 300px;
            animation: slideIn 0.2s ease;
        }

        .day-content.slide-left {
            animation: slideOutLeft 0.2s ease;
        }

        .day-content.slide-right {
            animation: slideOutRight 0.2s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(0);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOutLeft {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(-30px);
            }
        }

        @keyframes slideOutRight {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(30px);
            }
        }

        .day-tasks {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        /* Week View */
        .week-view-container {
            display: none;
        }

        .week-view-container.active {
            display: block;
        }

        /* Week Strip */
        .week-strip {
            display: flex;
            justify-content: space-between;
            gap: 0.25rem;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background: #0f0f0f;
            border: 1px solid #1a1a1a;
            border-radius: 12px;
        }

        .strip-day {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5rem 0.25rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #525252;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .strip-day:hover {
            background: #1a1a1a;
        }

        .strip-day.active {
            background: #3b82f6;
            color: #ffffff;
        }

        .strip-day.today:not(.active) {
            color: #3b82f6;
        }

        .strip-date {
            display: block;
            font-size: 0.9rem;
            font-weight: 600;
            margin-top: 0.25rem;
        }

        /* Week Carousel */
        .week-carousel {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
            gap: 0;
        }

        .week-carousel::-webkit-scrollbar {
            display: none;
        }

        .carousel-day {
            min-width: 100%;
            scroll-snap-align: start;
            background: #0f0f0f;
            border: 1px solid #1a1a1a;
            border-radius: 12px;
            padding: 1rem;
            min-height: 300px;
        }

        .carousel-day-header {
            text-align: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #1a1a1a;
        }

        .carousel-day-name {
            font-size: 0.8rem;
            font-weight: 500;
            color: #737373;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .carousel-day-date {
            font-size: 0.75rem;
            color: #525252;
            margin-top: 0.25rem;
        }

        /* Month View */
        .month-container {
            display: none;
        }

        .month-container.active {
            display: block;
        }

        /* Mobile Month List View */
        .month-list {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .month-date-section {
            background: #0f0f0f;
            border: 1px solid #1a1a1a;
            border-radius: 12px;
            margin-bottom: 0.75rem;
            overflow: hidden;
        }

        .month-date-section.today {
            border-color: #3b82f6;
            border-width: 2px;
        }

        .month-date-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.875rem 1rem;
            background: #111111;
            border-bottom: 1px solid #1a1a1a;
        }

        .month-date-section.today .month-date-header {
            background: rgba(59, 130, 246, 0.1);
        }

        .month-date-title {
            display: flex;
            align-items: baseline;
            gap: 0.5rem;
        }

        .month-date-day {
            font-size: 0.8rem;
            font-weight: 500;
            color: #737373;
            text-transform: uppercase;
        }

        .month-date-section.today .month-date-day {
            color: #3b82f6;
        }

        .month-date-num {
            font-size: 1.25rem;
            font-weight: 600;
            color: #e5e5e5;
        }

        .month-date-section.today .month-date-num {
            color: #3b82f6;
        }

        .month-date-badge {
            font-size: 0.65rem;
            font-weight: 500;
            color: #3b82f6;
            background: rgba(59, 130, 246, 0.15);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            display: none;
        }

        .month-date-section.today .month-date-badge {
            display: block;
        }

        .month-date-tasks {
            padding: 0.75rem;
        }

        .month-date-tasks .day-tasks {
            gap: 0.5rem;
        }

        .month-date-tasks .empty-day {
            padding: 1rem;
            font-size: 0.85rem;
        }

        .month-date-add {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 0.625rem;
            background: transparent;
            border: 1px dashed #262626;
            border-radius: 6px;
            color: #404040;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 0.5rem;
        }

        @media (hover: hover) {
            .month-date-add:hover {
                border-color: #404040;
                color: #525252;
            }
        }

        /* Desktop Month Grid View */
        .month-grid {
            display: none;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            background: #1a1a1a;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #1a1a1a;
        }

        .month-weekday-header {
            background: #0f0f0f;
            padding: 0.5rem;
            text-align: center;
            font-size: 0.65rem;
            font-weight: 500;
            color: #525252;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .month-day {
            background: #0a0a0a;
            min-height: 90px;
            padding: 0.375rem;
            display: flex;
            flex-direction: column;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        @media (hover: hover) {
            .month-day:not(.empty):hover {
                background: #111111;
            }
        }

        .month-day.empty {
            background: #050505;
            cursor: default;
        }

        .month-day.today {
            background: #111118;
            border: 1px solid #3b82f6;
        }

        .month-day-number {
            font-size: 0.75rem;
            color: #525252;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .month-day.today .month-day-number {
            color: #3b82f6;
            font-weight: 600;
        }

        .month-day.other-month .month-day-number {
            color: #333333;
        }

        /* Desktop Grid Task Items */
        .month-task-preview {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.2rem 0.3rem;
            background: #141414;
            border-radius: 4px;
            margin-bottom: 2px;
            cursor: pointer;
            transition: background 0.2s ease;
            overflow: hidden;
        }

        .month-task-preview:hover {
            background: #1a1a1a;
        }

        .month-task-preview.completed {
            opacity: 0.5;
        }

        .month-task-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #404040;
            flex-shrink: 0;
        }

        .month-task-preview.completed .month-task-dot {
            background: #3b82f6;
        }

        .month-task-text {
            font-size: 0.6rem;
            color: #a3a3a3;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }

        .month-task-preview.completed .month-task-text {
            text-decoration: line-through;
            color: #525252;
        }

        .month-more-tasks {
            font-size: 0.55rem;
            color: #3b82f6;
            padding: 0.15rem 0.3rem;
            text-align: center;
            cursor: pointer;
        }

        .month-more-tasks:hover {
            text-decoration: underline;
        }

        /* Task Indicators (fallback/dots) */
        .task-indicators {
            display: flex;
            gap: 3px;
            margin-top: 4px;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 100%;
        }

        .task-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #404040;
        }

        .task-dot.completed {
            background: #3b82f6;
        }

        .task-count {
            font-size: 0.6rem;
            color: #525252;
            margin-top: 2px;
        }

        /* Responsive: Show grid on desktop, list on mobile */
        @media (max-width: 599px) {
            .month-list {
                display: flex;
            }
            .month-grid {
                display: none !important;
            }
        }

        @media (min-width: 600px) {
            .month-list {
                display: none;
            }
            .month-grid {
                display: grid !important;
            }
        }

        /* Task Items */
        .task-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: #141414;
            border: 1px solid #1a1a1a;
            border-radius: 8px;
            padding: 0.875rem 1rem;
            transition: all 0.2s ease;
            animation: taskSlideIn 0.25s ease;
            position: relative;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .task-item.completed {
            background: #181818;
        }

        @keyframes taskSlideIn {
            from {
                opacity: 0;
                transform: translateY(-8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (hover: hover) {
            .task-item:hover {
                border-color: #262626;
            }
        }

        .task-item:active {
            background: #1a1a1a;
        }

        .task-checkbox {
            width: 20px;
            height: 20px;
            border: 1.5px solid #404040;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
            pointer-events: none;
        }

        .task-checkbox.checked {
            background: #3b82f6;
            border-color: #3b82f6;
        }

        .task-checkbox.checked::after {
            content: '';
            width: 10px;
            height: 6px;
            border: 2px solid #ffffff;
            border-top: none;
            border-right: none;
            transform: rotate(-45deg) translateY(-1px);
        }

        .task-content {
            flex: 1;
            min-width: 0;
            pointer-events: none;
        }

        .task-name {
            font-size: 0.95rem;
            color: #d4d4d4;
            transition: all 0.2s ease;
            word-break: break-word;
            overflow-wrap: break-word;
            line-height: 1.4;
        }

        .task-name.completed {
            color: #525252;
            opacity: 0.6;
        }

        .task-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.2rem;
            font-size: 0.65rem;
            color: #525252;
            margin-top: 0.25rem;
        }

        .task-badge svg {
            width: 10px;
            height: 10px;
        }

        .delete-button {
            width: 28px;
            height: 28px;
            background: transparent;
            border: none;
            color: #404040;
            font-size: 1rem;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            opacity: 0.5;
            pointer-events: auto;
            -webkit-tap-highlight-color: transparent;
        }

        @media (hover: hover) {
            .delete-button {
                opacity: 0;
            }

            .task-item:hover .delete-button {
                opacity: 1;
            }

            .delete-button:hover {
                color: #ef4444;
                background: rgba(239, 68, 68, 0.1);
            }
        }

        /* Empty State */
        .empty-day {
            text-align: center;
            padding: 2rem;
            color: #333333;
            font-size: 0.9rem;
        }

        /* XP Popup Animation */
        .xp-popup {
            position: absolute;
            left: 36px;
            bottom: 100%;
            font-size: 0.75rem;
            font-weight: 600;
            pointer-events: none;
            animation: xpFloat 1s ease forwards;
            white-space: nowrap;
        }

        .xp-popup.gain {
            color: #3b82f6;
        }

        .xp-popup.lose {
            color: #ef4444;
        }

        @keyframes xpFloat {
            0% {
                opacity: 0;
                transform: translateY(8px);
            }
            20% {
                opacity: 1;
            }
            100% {
                opacity: 0;
                transform: translateY(-16px);
            }
        }

        /* FAB */
        .fab {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            width: 56px;
            height: 56px;
            background: #3b82f6;
            border: none;
            border-radius: 50%;
            color: #ffffff;
            font-size: 1.75rem;
            font-weight: 300;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        @media (hover: hover) {
            .fab:hover {
                transform: scale(1.05);
                box-shadow: 0 6px 16px rgba(59, 130, 246, 0.5);
            }
        }

        .fab:active {
            transform: scale(0.95);
        }

        .fab.open {
            transform: rotate(45deg);
        }

        /* Modal Overlay */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.15s ease;
        }

        .modal-overlay.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Task Creation Modal */
        .task-modal {
            background: #141414;
            border: 1px solid #262626;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlide 0.2s ease;
        }

        @keyframes modalSlide {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #262626;
        }

        .modal-header span {
            font-size: 1rem;
            font-weight: 600;
            color: #e5e5e5;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            background: transparent;
            border: none;
            color: #737373;
            font-size: 1.25rem;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media (hover: hover) {
            .modal-close:hover {
                background: #262626;
                color: #e5e5e5;
            }
        }

        .modal-body {
            padding: 1.25rem;
        }

        .modal-field {
            margin-bottom: 1rem;
        }

        .modal-label {
            display: block;
            font-size: 0.8rem;
            font-weight: 500;
            color: #737373;
            margin-bottom: 0.5rem;
        }

        .modal-input {
            width: 100%;
            background: #0f0f0f;
            border: 1px solid #262626;
            border-radius: 8px;
            padding: 0.875rem 1rem;
            font-size: 1rem;
            color: #e5e5e5;
            outline: none;
            transition: all 0.2s ease;
        }

        .modal-input::placeholder {
            color: #525252;
        }

        .modal-input:focus {
            border-color: #3b82f6;
            background: #111111;
        }

        .modal-select {
            width: 100%;
            background: #0f0f0f;
            border: 1px solid #262626;
            border-radius: 8px;
            padding: 0.875rem 1rem;
            padding-right: 2rem;
            font-size: 1rem;
            color: #e5e5e5;
            outline: none;
            cursor: pointer;
            transition: all 0.2s ease;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23737373' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
        }

        .modal-select:focus {
            border-color: #3b82f6;
        }

        .modal-select option {
            background: #141414;
            color: #e5e5e5;
        }

        .modal-date-input {
            width: 100%;
            background: #0f0f0f;
            border: 1px solid #262626;
            border-radius: 8px;
            padding: 0.875rem 1rem;
            font-size: 1rem;
            color: #e5e5e5;
            outline: none;
            cursor: pointer;
            transition: all 0.2s ease;
            color-scheme: dark;
        }

        .modal-date-input:focus {
            border-color: #3b82f6;
        }

        /* Day Picker in Modal */
        .modal-day-picker {
            display: none;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .modal-day-picker.active {
            display: flex;
        }

        .modal-day-toggle {
            flex: 1;
            min-width: 40px;
            padding: 0.625rem 0.25rem;
            background: #0f0f0f;
            border: 1px solid #262626;
            border-radius: 8px;
            color: #525252;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
        }

        @media (hover: hover) {
            .modal-day-toggle:hover {
                border-color: #404040;
                color: #737373;
            }
        }

        .modal-day-toggle.selected {
            background: #3b82f6;
            border-color: #3b82f6;
            color: #ffffff;
        }

        .modal-footer {
            padding: 1rem 1.25rem;
            border-top: 1px solid #262626;
        }

        .modal-submit {
            width: 100%;
            padding: 0.875rem;
            background: #3b82f6;
            border: none;
            border-radius: 8px;
            color: #ffffff;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        @media (hover: hover) {
            .modal-submit:hover {
                background: #2563eb;
            }
        }

        .modal-submit:active {
            transform: scale(0.98);
        }

        /* Delete Modal */
        .modal {
            background: #141414;
            border: 1px solid #262626;
            border-radius: 12px;
            padding: 1.25rem;
            max-width: 300px;
            width: 90%;
            animation: modalSlide 0.15s ease;
        }

        .modal-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #e5e5e5;
            margin-bottom: 0.375rem;
        }

        .modal-text {
            font-size: 0.8rem;
            color: #737373;
            margin-bottom: 1rem;
            line-height: 1.4;
        }

        .modal-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.375rem;
        }

        .modal-btn {
            padding: 0.625rem 0.875rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .modal-btn-primary {
            background: #1a1a1a;
            border-color: #262626;
            color: #ef4444;
        }

        @media (hover: hover) {
            .modal-btn-primary:hover {
                background: #262626;
            }
        }

        .modal-btn-secondary {
            background: #1a1a1a;
            border-color: #262626;
            color: #d4d4d4;
        }

        @media (hover: hover) {
            .modal-btn-secondary:hover {
                background: #262626;
            }
        }

        .modal-btn-cancel {
            background: transparent;
            color: #525252;
        }

        @media (hover: hover) {
            .modal-btn-cancel:hover {
                color: #737373;
            }
        }

        /* Bottom Sheet */
        .bottom-sheet-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 900;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .bottom-sheet-overlay.active {
            display: block;
            opacity: 1;
        }

        .bottom-sheet {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            background: #141414;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            z-index: 950;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            max-height: 70vh;
            display: flex;
            flex-direction: column;
        }

        .bottom-sheet.open {
            transform: translateY(0);
        }

        .sheet-handle {
            width: 40px;
            height: 4px;
            background: #404040;
            border-radius: 2px;
            margin: 12px auto;
        }

        .sheet-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.25rem 1rem;
            border-bottom: 1px solid #262626;
        }

        .sheet-date {
            font-size: 1rem;
            font-weight: 600;
            color: #e5e5e5;
        }

        .sheet-close {
            width: 32px;
            height: 32px;
            background: transparent;
            border: none;
            color: #737373;
            font-size: 1.25rem;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media (hover: hover) {
            .sheet-close:hover {
                background: #262626;
                color: #e5e5e5;
            }
        }

        .sheet-tasks {
            flex: 1;
            overflow-y: auto;
            padding: 1rem 1.25rem;
            padding-bottom: 2rem;
        }

        .sheet-add-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            width: 100%;
            padding: 0.875rem;
            background: #0f0f0f;
            border: 1px dashed #262626;
            border-radius: 8px;
            color: #525252;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 0.75rem;
        }

        @media (hover: hover) {
            .sheet-add-btn:hover {
                border-color: #404040;
                color: #737373;
            }
        }

        /* Responsive */
        @media (min-width: 600px) {
            .container {
                max-width: 900px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1 class="app-title">Life Gamified</h1>
            <p class="app-subtitle">Turn your daily habits into an adventure</p>
            <div class="level-container">
                <div class="level-info">
                    <span class="level-badge">Level <span id="currentLevel">1</span></span>
                    <span class="xp-text"><span id="currentXp">0</span> / <span id="xpToNext">100</span> XP</span>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
            </div>
        </header>

        <div class="date-nav" id="dateNav">
            <button type="button" class="nav-arrow" id="prevDate">&#8592;</button>
            <div class="date-display" id="dateDisplay">Wednesday, January 15</div>
            <button type="button" class="nav-arrow" id="nextDate">&#8594;</button>
            <button type="button" class="today-btn" id="todayBtn">Today</button>
        </div>

        <div class="view-toggle-container">
            <div class="view-toggle">
                <button type="button" class="view-btn" id="dayViewBtn">Day</button>
                <button type="button" class="view-btn" id="weekViewBtn">Week</button>
                <button type="button" class="view-btn" id="monthViewBtn">Month</button>
            </div>
        </div>

        <!-- Day View -->
        <div class="day-view-container" id="dayViewContainer">
            <div class="day-content" id="dayContent">
                <div class="day-tasks" id="dayTasks"></div>
            </div>
        </div>

        <!-- Week View -->
        <div class="week-view-container" id="weekViewContainer">
            <div class="week-strip" id="weekStrip"></div>
            <div class="week-carousel" id="weekCarousel"></div>
        </div>

        <!-- Month View -->
        <div class="month-container" id="monthContainer">
            <div class="month-list" id="monthList"></div>
            <div class="month-grid" id="monthGrid"></div>
        </div>
    </div>

    <!-- FAB -->
    <button type="button" class="fab" id="fabButton">+</button>

    <!-- Task Creation Modal -->
    <div class="modal-overlay" id="createTaskModal">
        <div class="task-modal">
            <div class="modal-header">
                <span>New Task</span>
                <button type="button" class="modal-close" id="modalCloseBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-field">
                    <label class="modal-label">Task Name</label>
                    <input type="text" class="modal-input" id="modalTaskInput" placeholder="What do you want to do?">
                </div>
                <div class="modal-field">
                    <label class="modal-label">Type</label>
                    <select class="modal-select" id="modalTypeSelect">
                        <option value="onetime">One-time</option>
                        <option value="daily">Daily</option>
                        <option value="custom">Custom Days</option>
                    </select>
                </div>
                <div class="modal-field" id="modalDateField">
                    <label class="modal-label">Date</label>
                    <input type="date" class="modal-date-input" id="modalDateInput">
                </div>
                <div class="modal-field" id="modalDayPickerField" style="display: none;">
                    <label class="modal-label">Select Days</label>
                    <div class="modal-day-picker active" id="modalDayPicker">
                        <button type="button" class="modal-day-toggle" data-day="0">Mon</button>
                        <button type="button" class="modal-day-toggle" data-day="1">Tue</button>
                        <button type="button" class="modal-day-toggle" data-day="2">Wed</button>
                        <button type="button" class="modal-day-toggle" data-day="3">Thu</button>
                        <button type="button" class="modal-day-toggle" data-day="4">Fri</button>
                        <button type="button" class="modal-day-toggle" data-day="5">Sat</button>
                        <button type="button" class="modal-day-toggle" data-day="6">Sun</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="modal-submit" id="modalSubmitBtn">Add Task</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal">
            <div class="modal-title" id="modalTitle">Delete Repeating Task</div>
            <div class="modal-text" id="modalText">This task repeats on multiple days. How would you like to delete it?</div>
            <div class="modal-buttons">
                <button type="button" class="modal-btn modal-btn-secondary" onclick="deleteThisDay()">Delete from this day only</button>
                <button type="button" class="modal-btn modal-btn-primary" onclick="deleteAllDays()">Delete from all days</button>
                <button type="button" class="modal-btn modal-btn-cancel" onclick="closeDeleteModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Bottom Sheet -->
    <div class="bottom-sheet-overlay" id="bottomSheetOverlay"></div>
    <div class="bottom-sheet" id="bottomSheet">
        <div class="sheet-handle"></div>
        <div class="sheet-header">
            <span class="sheet-date" id="sheetDate">Wednesday, Jan 15</span>
            <button type="button" class="sheet-close" id="sheetCloseBtn">&times;</button>
        </div>
        <div class="sheet-tasks" id="sheetTasks"></div>
    </div>

    <script>
        // DOM Elements
        const currentLevelEl = document.getElementById('currentLevel');
        const currentXpEl = document.getElementById('currentXp');
        const xpToNextEl = document.getElementById('xpToNext');
        const progressBar = document.getElementById('progressBar');
        const dateDisplay = document.getElementById('dateDisplay');
        const prevDateBtn = document.getElementById('prevDate');
        const nextDateBtn = document.getElementById('nextDate');
        const todayBtn = document.getElementById('todayBtn');
        const dayViewBtn = document.getElementById('dayViewBtn');
        const weekViewBtn = document.getElementById('weekViewBtn');
        const monthViewBtn = document.getElementById('monthViewBtn');
        const dayViewContainer = document.getElementById('dayViewContainer');
        const weekViewContainer = document.getElementById('weekViewContainer');
        const monthContainer = document.getElementById('monthContainer');
        const dayContent = document.getElementById('dayContent');
        const dayTasks = document.getElementById('dayTasks');
        const weekStrip = document.getElementById('weekStrip');
        const weekCarousel = document.getElementById('weekCarousel');
        const monthGrid = document.getElementById('monthGrid');
        const monthList = document.getElementById('monthList');
        const fabButton = document.getElementById('fabButton');
        const createTaskModal = document.getElementById('createTaskModal');
        const modalCloseBtn = document.getElementById('modalCloseBtn');
        const modalTaskInput = document.getElementById('modalTaskInput');
        const modalTypeSelect = document.getElementById('modalTypeSelect');
        const modalDateInput = document.getElementById('modalDateInput');
        const modalDateField = document.getElementById('modalDateField');
        const modalDayPickerField = document.getElementById('modalDayPickerField');
        const modalDayPicker = document.getElementById('modalDayPicker');
        const modalSubmitBtn = document.getElementById('modalSubmitBtn');
        const deleteModal = document.getElementById('deleteModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalText = document.getElementById('modalText');
        const bottomSheetOverlay = document.getElementById('bottomSheetOverlay');
        const bottomSheet = document.getElementById('bottomSheet');
        const sheetDate = document.getElementById('sheetDate');
        const sheetTasks = document.getElementById('sheetTasks');
        const sheetCloseBtn = document.getElementById('sheetCloseBtn');
        const dateNav = document.getElementById('dateNav');

        // State
        let totalXp = 0;
        let dailyTaskCounter = 0;
        let taskIdCounter = 0;
        let pendingDeleteTask = null;
        let pendingDeleteContext = null;
        let currentView = 'day';
        let viewingDate = new Date();
        let viewingMonth = new Date().getMonth();
        let viewingYear = new Date().getFullYear();
        let selectedSheetDate = null;
        let tasks = []; // Master task list
        let taskCompletions = {}; // Track completions by date

        // Swipe tracking
        let touchStartX = 0;
        let touchStartY = 0;
        let touchEndX = 0;
        let touchEndY = 0;
        const SWIPE_THRESHOLD = 50;

        // Constants
        const STORAGE_KEY = 'lifeGamifiedData';
        const VIEW_STORAGE_KEY = 'lifeGamifiedView';
        const XP_PER_LEVEL = 100;
        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        const dayAbbrev = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                           'July', 'August', 'September', 'October', 'November', 'December'];

        const repeatIcon = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 1l4 4-4 4"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><path d="M7 23l-4-4 4-4"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>`;

        // Utility Functions
        function getTodayIndex() {
            const jsDay = new Date().getDay();
            return jsDay === 0 ? 6 : jsDay - 1;
        }

        function getWeekdayFromDate(date) {
            const jsDay = date.getDay();
            return jsDay === 0 ? 6 : jsDay - 1;
        }

        function formatDateForInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDateForDisplay(date) {
            const dayName = days[getWeekdayFromDate(date)];
            const monthName = monthNames[date.getMonth()];
            return `${dayName}, ${monthName} ${date.getDate()}`;
        }

        function formatDateShort(date) {
            const monthShort = monthNames[date.getMonth()].slice(0, 3);
            return `${monthShort} ${date.getDate()}`;
        }

        function getWeekDates(centerDate) {
            const weekday = getWeekdayFromDate(centerDate);
            const weekDates = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(centerDate);
                date.setDate(centerDate.getDate() - weekday + i);
                weekDates.push(date);
            }
            return weekDates;
        }

        function isSameDay(date1, date2) {
            return formatDateForInput(date1) === formatDateForInput(date2);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getPatternLabel(pattern) {
            if (!pattern) return 'Daily';
            if (pattern === 'daily') return 'Daily';

            const indices = pattern.split(',').map(Number);
            if (indices.length === 7) return 'Daily';
            if (indices.length === 5 && indices.join(',') === '0,1,2,3,4') return 'Weekdays';
            if (indices.length === 2 && indices.join(',') === '5,6') return 'Weekends';

            return indices.map(i => dayAbbrev[i]).join(', ');
        }

        // Completion Tracking
        function isTaskCompletedForDate(taskId, dateStr) {
            return taskCompletions[taskId]?.[dateStr] === true;
        }

        function setTaskCompletedForDate(taskId, dateStr, completed) {
            if (!taskCompletions[taskId]) {
                taskCompletions[taskId] = {};
            }
            if (completed) {
                taskCompletions[taskId][dateStr] = true;
            } else {
                delete taskCompletions[taskId][dateStr];
            }
        }

        function recalculateXpFromCompletions() {
            let calculatedXp = 0;
            for (const taskId in taskCompletions) {
                for (const dateStr in taskCompletions[taskId]) {
                    if (taskCompletions[taskId][dateStr] === true) {
                        calculatedXp += 10;
                    }
                }
            }
            return calculatedXp;
        }

        // Level System
        function getLevel(xp) {
            return Math.floor(xp / XP_PER_LEVEL) + 1;
        }

        function getXpInCurrentLevel(xp) {
            return xp % XP_PER_LEVEL;
        }

        function updateLevelDisplay() {
            const level = getLevel(totalXp);
            const xpInLevel = getXpInCurrentLevel(totalXp);
            const progress = (xpInLevel / XP_PER_LEVEL) * 100;

            currentLevelEl.textContent = level;
            currentXpEl.textContent = xpInLevel;
            xpToNextEl.textContent = XP_PER_LEVEL;
            progressBar.style.width = progress + '%';
        }

        // Task Data Functions
        function getTasksForDate(date) {
            const dateStr = formatDateForInput(date);
            const weekdayIndex = getWeekdayFromDate(date);

            return tasks.filter(task => {
                if (task.type === 'daily') {
                    return true;
                } else if (task.type === 'custom') {
                    const taskDays = task.pattern.split(',').map(Number);
                    return taskDays.includes(weekdayIndex);
                } else {
                    // One-time task
                    return task.date === dateStr;
                }
            }).map(task => {
                const completionKey = task.dailyId || task.id;
                const completionDate = task.type === 'onetime' ? task.date : dateStr;
                return {
                    ...task,
                    completed: isTaskCompletedForDate(completionKey, completionDate)
                };
            });
        }

        // Date Navigation
        function navigateDay(delta) {
            const oldDate = new Date(viewingDate);
            viewingDate.setDate(viewingDate.getDate() + delta);

            // Update month/year if needed
            viewingMonth = viewingDate.getMonth();
            viewingYear = viewingDate.getFullYear();

            updateDateDisplay();

            if (currentView === 'day') {
                // Animate transition
                const direction = delta > 0 ? 'left' : 'right';
                dayContent.classList.add(`slide-${direction}`);
                setTimeout(() => {
                    dayContent.classList.remove(`slide-${direction}`);
                    renderDayView();
                }, 150);
            } else if (currentView === 'week') {
                // Check if we moved to a different week
                const oldWeekStart = getWeekDates(oldDate)[0];
                const newWeekStart = getWeekDates(viewingDate)[0];
                if (!isSameDay(oldWeekStart, newWeekStart)) {
                    renderWeekView();
                } else {
                    syncWeekStrip();
                    scrollCarouselToDay();
                }
            }
        }

        function goToToday() {
            viewingDate = new Date();
            viewingMonth = viewingDate.getMonth();
            viewingYear = viewingDate.getFullYear();
            updateDateDisplay();
            renderCurrentView();
        }

        function updateDateDisplay() {
            dateDisplay.textContent = formatDateForDisplay(viewingDate);

            // Highlight Today button if viewing today
            const isToday = isSameDay(viewingDate, new Date());
            todayBtn.classList.toggle('active', isToday);
        }

        // View Management
        function setView(view) {
            currentView = view;

            dayViewContainer.classList.remove('active');
            weekViewContainer.classList.remove('active');
            monthContainer.classList.remove('active');

            dayViewBtn.classList.remove('active');
            weekViewBtn.classList.remove('active');
            monthViewBtn.classList.remove('active');

            // Show/hide date navigation arrows based on view
            const arrows = dateNav.querySelectorAll('.nav-arrow');
            if (view === 'month') {
                arrows.forEach(a => a.style.display = 'flex');
            } else if (view === 'week') {
                arrows.forEach(a => a.style.display = 'none');
            } else {
                arrows.forEach(a => a.style.display = 'flex');
            }

            if (view === 'day') {
                dayViewContainer.classList.add('active');
                dayViewBtn.classList.add('active');
                renderDayView();
            } else if (view === 'week') {
                weekViewContainer.classList.add('active');
                weekViewBtn.classList.add('active');
                renderWeekView();
            } else {
                monthContainer.classList.add('active');
                monthViewBtn.classList.add('active');
                renderMonthView();
            }

            updateDateDisplay();
            localStorage.setItem(VIEW_STORAGE_KEY, view);
        }

        function renderCurrentView() {
            if (currentView === 'day') {
                renderDayView();
            } else if (currentView === 'week') {
                renderWeekView();
            } else {
                renderMonthView();
            }
        }

        // Day View
        function renderDayView() {
            const dateStr = formatDateForInput(viewingDate);
            const tasksForDay = getTasksForDate(viewingDate);

            dayTasks.innerHTML = '';

            if (tasksForDay.length === 0) {
                dayTasks.innerHTML = '<div class="empty-day">No tasks for this day</div>';
                return;
            }

            tasksForDay.forEach(task => {
                const taskEl = createTaskElement(task, dateStr);
                dayTasks.appendChild(taskEl);
            });
        }

        function createTaskElement(task, dateStr) {
            const taskItem = document.createElement('div');
            taskItem.className = 'task-item' + (task.completed ? ' completed' : '');
            taskItem.dataset.taskId = task.id;
            taskItem.dataset.dateStr = dateStr;

            if (task.dailyId) {
                taskItem.dataset.dailyId = task.dailyId;
            }
            if (task.pattern) {
                taskItem.dataset.pattern = task.pattern;
            }
            if (task.type) {
                taskItem.dataset.type = task.type;
            }

            let badge = '';
            if (task.type === 'daily' || task.type === 'custom') {
                badge = `<div class="task-badge">${repeatIcon}</div>`;
            }

            const checkedClass = task.completed ? ' checked' : '';
            const completedClass = task.completed ? ' completed' : '';

            taskItem.innerHTML = `
                <div class="task-checkbox${checkedClass}"></div>
                <div class="task-content">
                    <span class="task-name${completedClass}">${escapeHtml(task.name)}</span>
                    ${badge}
                </div>
                <button type="button" class="delete-button">&times;</button>
            `;

            // Event listeners
            let touchHandled = false;

            taskItem.addEventListener('touchend', function(e) {
                if (e.target.classList.contains('delete-button')) return;
                e.preventDefault();
                touchHandled = true;
                toggleTask(this);
                setTimeout(() => { touchHandled = false; }, 300);
            }, { passive: false });

            taskItem.addEventListener('click', function(e) {
                if (e.target.classList.contains('delete-button')) return;
                if (!touchHandled) {
                    toggleTask(this);
                }
            });

            const deleteBtn = taskItem.querySelector('.delete-button');
            deleteBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                handleDeleteTask(taskItem);
            });

            return taskItem;
        }

        function toggleTask(taskItem) {
            const taskId = taskItem.dataset.taskId;
            const dateStr = taskItem.dataset.dateStr;
            const dailyId = taskItem.dataset.dailyId;

            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            const completionKey = dailyId || taskId;
            const completionDate = task.type === 'onetime' ? task.date : dateStr;
            const wasCompleted = isTaskCompletedForDate(completionKey, completionDate);
            const isNowCompleted = !wasCompleted;

            setTaskCompletedForDate(completionKey, completionDate, isNowCompleted);

            // Update UI
            const checkbox = taskItem.querySelector('.task-checkbox');
            const taskName = taskItem.querySelector('.task-name');
            checkbox.classList.toggle('checked', isNowCompleted);
            taskName.classList.toggle('completed', isNowCompleted);
            taskItem.classList.toggle('completed', isNowCompleted);

            // XP popup
            const popup = document.createElement('span');
            popup.className = 'xp-popup ' + (isNowCompleted ? 'gain' : 'lose');
            popup.textContent = (isNowCompleted ? '+' : '-') + '10 XP';
            taskItem.appendChild(popup);
            setTimeout(() => popup.remove(), 1000);

            // Update XP
            totalXp += isNowCompleted ? 10 : -10;
            if (totalXp < 0) totalXp = 0;
            updateLevelDisplay();

            saveData();
        }

        function handleDeleteTask(taskItem) {
            const taskId = taskItem.dataset.taskId;
            const dailyId = taskItem.dataset.dailyId;
            const dateStr = taskItem.dataset.dateStr;
            const type = taskItem.dataset.type;

            if (dailyId || type === 'daily' || type === 'custom') {
                // Recurring task - show modal
                pendingDeleteTask = taskItem;
                pendingDeleteContext = { taskId, dailyId, dateStr, type };

                const task = tasks.find(t => t.id === taskId);
                const label = getPatternLabel(task?.pattern);

                modalTitle.textContent = 'Delete Repeating Task';
                modalText.textContent = `This task repeats (${label}). How would you like to delete it?`;
                deleteModal.classList.add('active');
            } else {
                // One-time task - delete directly
                deleteTaskCompletely(taskId);
            }
        }

        function deleteThisDay() {
            if (!pendingDeleteContext) return;

            const { taskId, dailyId, dateStr } = pendingDeleteContext;
            const completionKey = dailyId || taskId;

            // Remove XP if completed for this date
            if (isTaskCompletedForDate(completionKey, dateStr)) {
                totalXp -= 10;
                if (totalXp < 0) totalXp = 0;
                updateLevelDisplay();
            }

            // Remove completion for this date
            if (taskCompletions[completionKey]) {
                delete taskCompletions[completionKey][dateStr];
            }

            saveData();
            renderCurrentView();
            closeDeleteModal();
        }

        function deleteAllDays() {
            if (!pendingDeleteContext) return;

            const { taskId, dailyId } = pendingDeleteContext;
            const completionKey = dailyId || taskId;

            deleteTaskCompletely(taskId, completionKey);
            closeDeleteModal();
        }

        function deleteTaskCompletely(taskId, completionKey = null) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            const key = completionKey || task.dailyId || taskId;

            // Remove XP for all completed dates
            if (taskCompletions[key]) {
                const completedCount = Object.values(taskCompletions[key]).filter(v => v === true).length;
                if (completedCount > 0) {
                    totalXp -= completedCount * 10;
                    if (totalXp < 0) totalXp = 0;
                    updateLevelDisplay();
                }
                delete taskCompletions[key];
            }

            // Remove task from list
            tasks = tasks.filter(t => t.id !== taskId);

            saveData();
            renderCurrentView();

            // Close bottom sheet if open
            if (bottomSheet.classList.contains('open')) {
                renderBottomSheetTasks();
            }
        }

        function closeDeleteModal() {
            deleteModal.classList.remove('active');
            pendingDeleteTask = null;
            pendingDeleteContext = null;
        }

        // Week View
        function renderWeekView() {
            const weekDates = getWeekDates(viewingDate);
            const today = new Date();

            // Render strip
            weekStrip.innerHTML = '';
            weekDates.forEach((date, index) => {
                const stripDay = document.createElement('div');
                stripDay.className = 'strip-day';
                if (isSameDay(date, viewingDate)) stripDay.classList.add('active');
                if (isSameDay(date, today)) stripDay.classList.add('today');
                stripDay.dataset.index = index;
                stripDay.dataset.date = formatDateForInput(date);

                stripDay.innerHTML = `
                    ${dayAbbrev[index].charAt(0)}
                    <span class="strip-date">${date.getDate()}</span>
                `;

                stripDay.addEventListener('click', () => {
                    viewingDate = new Date(date);
                    updateDateDisplay();
                    syncWeekStrip();
                    scrollCarouselToDay(index);
                });

                weekStrip.appendChild(stripDay);
            });

            // Render carousel
            weekCarousel.innerHTML = '';
            weekDates.forEach((date, index) => {
                const carouselDay = document.createElement('div');
                carouselDay.className = 'carousel-day';
                carouselDay.dataset.index = index;
                carouselDay.dataset.date = formatDateForInput(date);

                const dateStr = formatDateForInput(date);
                const tasksForDay = getTasksForDate(date);

                let tasksHtml = '';
                if (tasksForDay.length === 0) {
                    tasksHtml = '<div class="empty-day">No tasks</div>';
                } else {
                    tasksForDay.forEach(task => {
                        const taskEl = createTaskElement(task, dateStr);
                        tasksHtml += taskEl.outerHTML;
                    });
                }

                carouselDay.innerHTML = `
                    <div class="carousel-day-header">
                        <div class="carousel-day-name">${days[index]}</div>
                        <div class="carousel-day-date">${formatDateShort(date)}</div>
                    </div>
                    <div class="day-tasks">${tasksHtml}</div>
                `;

                // Re-attach event listeners to task items
                carouselDay.querySelectorAll('.task-item').forEach(taskItem => {
                    let touchHandled = false;

                    taskItem.addEventListener('touchend', function(e) {
                        if (e.target.classList.contains('delete-button')) return;
                        e.preventDefault();
                        touchHandled = true;
                        toggleTask(this);
                        setTimeout(() => { touchHandled = false; }, 300);
                    }, { passive: false });

                    taskItem.addEventListener('click', function(e) {
                        if (e.target.classList.contains('delete-button')) return;
                        if (!touchHandled) {
                            toggleTask(this);
                        }
                    });

                    const deleteBtn = taskItem.querySelector('.delete-button');
                    deleteBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        handleDeleteTask(taskItem);
                    });
                });

                weekCarousel.appendChild(carouselDay);
            });

            // Scroll to current day
            scrollCarouselToDay();

            // Set up scroll listener for carousel
            weekCarousel.addEventListener('scrollend', handleCarouselScroll);
            weekCarousel.addEventListener('scroll', debounce(handleCarouselScroll, 150));
        }

        function scrollCarouselToDay(index = null) {
            if (index === null) {
                index = getWeekdayFromDate(viewingDate);
            }
            const carouselDay = weekCarousel.children[index];
            if (carouselDay) {
                weekCarousel.scrollTo({
                    left: carouselDay.offsetLeft,
                    behavior: 'smooth'
                });
            }
        }

        function handleCarouselScroll() {
            const scrollLeft = weekCarousel.scrollLeft;
            const cardWidth = weekCarousel.offsetWidth;
            const activeIndex = Math.round(scrollLeft / cardWidth);

            const weekDates = getWeekDates(viewingDate);
            if (weekDates[activeIndex]) {
                const newDate = weekDates[activeIndex];
                if (!isSameDay(newDate, viewingDate)) {
                    viewingDate = new Date(newDate);
                    updateDateDisplay();
                    syncWeekStrip();
                }
            }
        }

        function syncWeekStrip() {
            const activeIndex = getWeekdayFromDate(viewingDate);
            weekStrip.querySelectorAll('.strip-day').forEach((day, i) => {
                day.classList.toggle('active', i === activeIndex);
            });
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // Month View
        function renderMonthView() {
            // Update date display for month view
            dateDisplay.textContent = `${monthNames[viewingMonth]} ${viewingYear}`;

            // Render both views (CSS handles which one is visible)
            renderMonthListView();
            renderMonthGridView();
        }

        // Mobile: Vertical scrollable list
        function renderMonthListView() {
            monthList.innerHTML = '';

            const lastDay = new Date(viewingYear, viewingMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const today = new Date();
            const isCurrentMonth = today.getMonth() === viewingMonth && today.getFullYear() === viewingYear;

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(viewingYear, viewingMonth, day);
                const isToday = isCurrentMonth && day === today.getDate();
                const dateStr = formatDateForInput(date);
                const weekdayIndex = getWeekdayFromDate(date);
                const tasksForDay = getTasksForDate(date);

                const section = document.createElement('div');
                section.className = 'month-date-section' + (isToday ? ' today' : '');
                section.dataset.date = dateStr;

                // Header
                const header = document.createElement('div');
                header.className = 'month-date-header';

                const title = document.createElement('div');
                title.className = 'month-date-title';
                title.innerHTML = `
                    <span class="month-date-day">${dayAbbrev[weekdayIndex]}</span>
                    <span class="month-date-num">${day}</span>
                `;

                const badge = document.createElement('span');
                badge.className = 'month-date-badge';
                badge.textContent = 'Today';

                header.appendChild(title);
                header.appendChild(badge);
                section.appendChild(header);

                // Tasks container
                const tasksContainer = document.createElement('div');
                tasksContainer.className = 'month-date-tasks';

                if (tasksForDay.length === 0) {
                    const emptyState = document.createElement('div');
                    emptyState.className = 'empty-day';
                    emptyState.textContent = 'No tasks';
                    tasksContainer.appendChild(emptyState);
                } else {
                    const tasksList = document.createElement('div');
                    tasksList.className = 'day-tasks';

                    tasksForDay.forEach(task => {
                        const taskEl = createTaskElement(task, dateStr);
                        tasksList.appendChild(taskEl);
                    });

                    tasksContainer.appendChild(tasksList);
                }

                // Add task button
                const addBtn = document.createElement('button');
                addBtn.type = 'button';
                addBtn.className = 'month-date-add';
                addBtn.textContent = '+ Add task';
                addBtn.addEventListener('click', () => {
                    openCreateTaskModal(dateStr);
                });
                tasksContainer.appendChild(addBtn);

                section.appendChild(tasksContainer);
                monthList.appendChild(section);
            }

            // Scroll to today if in current month
            if (isCurrentMonth) {
                setTimeout(() => {
                    const todaySection = monthList.querySelector('.month-date-section.today');
                    if (todaySection) {
                        todaySection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 100);
            }
        }

        // Desktop: 7-column grid with task previews
        function renderMonthGridView() {
            monthGrid.innerHTML = '';

            // Weekday headers
            const weekdayHeaders = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            weekdayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.className = 'month-weekday-header';
                header.textContent = day;
                monthGrid.appendChild(header);
            });

            // Get first day and days in month
            const firstDay = new Date(viewingYear, viewingMonth, 1);
            const lastDay = new Date(viewingYear, viewingMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const jsStartDay = firstDay.getDay();
            const startDayOfWeek = jsStartDay === 0 ? 6 : jsStartDay - 1;

            const today = new Date();
            const isCurrentMonth = today.getMonth() === viewingMonth && today.getFullYear() === viewingYear;

            // Empty cells before first day
            for (let i = 0; i < startDayOfWeek; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'month-day empty';
                monthGrid.appendChild(emptyCell);
            }

            // Day cells
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(viewingYear, viewingMonth, day);
                const isToday = isCurrentMonth && day === today.getDate();
                const dateStr = formatDateForInput(date);

                const dayCell = document.createElement('div');
                dayCell.className = 'month-day' + (isToday ? ' today' : '');
                dayCell.dataset.date = dateStr;

                const dayNumber = document.createElement('div');
                dayNumber.className = 'month-day-number';
                dayNumber.textContent = day;
                dayCell.appendChild(dayNumber);

                // Task previews (show up to 2, then "+X more")
                const tasksForDay = getTasksForDate(date);
                const maxVisible = 2;

                if (tasksForDay.length > 0) {
                    const tasksToShow = tasksForDay.slice(0, maxVisible);

                    tasksToShow.forEach(task => {
                        const preview = document.createElement('div');
                        preview.className = 'month-task-preview' + (task.completed ? ' completed' : '');

                        const dot = document.createElement('span');
                        dot.className = 'month-task-dot';

                        const text = document.createElement('span');
                        text.className = 'month-task-text';
                        text.textContent = task.name;

                        preview.appendChild(dot);
                        preview.appendChild(text);
                        dayCell.appendChild(preview);
                    });

                    if (tasksForDay.length > maxVisible) {
                        const moreBtn = document.createElement('div');
                        moreBtn.className = 'month-more-tasks';
                        moreBtn.textContent = `+${tasksForDay.length - maxVisible} more`;
                        dayCell.appendChild(moreBtn);
                    }
                }

                // Click to open bottom sheet
                dayCell.addEventListener('click', () => {
                    openBottomSheet(dateStr);
                });

                monthGrid.appendChild(dayCell);
            }

            // Fill remaining cells
            const totalCells = startDayOfWeek + daysInMonth;
            const remainingCells = (7 - (totalCells % 7)) % 7;
            for (let i = 0; i < remainingCells; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'month-day empty';
                monthGrid.appendChild(emptyCell);
            }
        }

        // Bottom Sheet
        function openBottomSheet(dateStr) {
            selectedSheetDate = dateStr;
            const date = new Date(dateStr + 'T00:00:00');
            sheetDate.textContent = formatDateForDisplay(date);

            renderBottomSheetTasks();

            bottomSheetOverlay.classList.add('active');
            bottomSheet.classList.add('open');
        }

        function renderBottomSheetTasks() {
            if (!selectedSheetDate) return;

            const date = new Date(selectedSheetDate + 'T00:00:00');
            const tasksForDay = getTasksForDate(date);

            sheetTasks.innerHTML = '';

            if (tasksForDay.length === 0) {
                sheetTasks.innerHTML = '<div class="empty-day">No tasks for this day</div>';
            } else {
                const tasksList = document.createElement('div');
                tasksList.className = 'day-tasks';

                tasksForDay.forEach(task => {
                    const taskEl = createTaskElement(task, selectedSheetDate);
                    tasksList.appendChild(taskEl);
                });

                sheetTasks.appendChild(tasksList);
            }

            // Add button to create task for this date
            const addBtn = document.createElement('button');
            addBtn.type = 'button';
            addBtn.className = 'sheet-add-btn';
            addBtn.innerHTML = '+ Add task for this day';
            addBtn.addEventListener('click', () => {
                closeBottomSheet();
                openCreateTaskModal(selectedSheetDate);
            });
            sheetTasks.appendChild(addBtn);
        }

        function closeBottomSheet() {
            bottomSheetOverlay.classList.remove('active');
            bottomSheet.classList.remove('open');
            selectedSheetDate = null;
        }

        // Task Creation Modal
        function openCreateTaskModal(presetDate = null) {
            createTaskModal.classList.add('active');
            fabButton.classList.add('open');

            // Reset form
            modalTaskInput.value = '';
            modalTypeSelect.value = 'onetime';
            modalDateInput.value = presetDate || formatDateForInput(viewingDate);
            modalDateField.style.display = 'block';
            modalDayPickerField.style.display = 'none';
            clearModalDayPicker();

            setTimeout(() => modalTaskInput.focus(), 100);
        }

        function closeCreateTaskModal() {
            createTaskModal.classList.remove('active');
            fabButton.classList.remove('open');
        }

        function clearModalDayPicker() {
            modalDayPicker.querySelectorAll('.modal-day-toggle').forEach(btn => {
                btn.classList.remove('selected');
            });
        }

        function getSelectedModalDays() {
            const selected = [];
            modalDayPicker.querySelectorAll('.modal-day-toggle.selected').forEach(btn => {
                selected.push(parseInt(btn.dataset.day));
            });
            return selected.sort((a, b) => a - b);
        }

        function addTask() {
            const taskName = modalTaskInput.value.trim();
            if (!taskName) return;

            const type = modalTypeSelect.value;
            const taskId = 'task-' + (++taskIdCounter);

            const newTask = {
                id: taskId,
                name: taskName,
                type: type
            };

            if (type === 'daily') {
                newTask.dailyId = 'daily-' + (++dailyTaskCounter);
                newTask.pattern = 'daily';
            } else if (type === 'custom') {
                const selectedDays = getSelectedModalDays();
                if (selectedDays.length === 0) {
                    alert('Please select at least one day');
                    return;
                }
                newTask.dailyId = 'daily-' + (++dailyTaskCounter);
                newTask.pattern = selectedDays.join(',');
            } else {
                // One-time
                const date = modalDateInput.value;
                if (!date) {
                    alert('Please select a date');
                    return;
                }
                newTask.date = date;
            }

            tasks.push(newTask);
            saveData();

            closeCreateTaskModal();
            renderCurrentView();

            // Refresh bottom sheet if open
            if (bottomSheet.classList.contains('open')) {
                renderBottomSheetTasks();
            }
        }

        // Swipe Gestures for Day View
        function setupSwipeGestures() {
            dayViewContainer.addEventListener('touchstart', e => {
                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
            }, { passive: true });

            dayViewContainer.addEventListener('touchend', e => {
                touchEndX = e.changedTouches[0].screenX;
                touchEndY = e.changedTouches[0].screenY;
                handleSwipe();
            }, { passive: true });
        }

        function handleSwipe() {
            const diffX = touchStartX - touchEndX;
            const diffY = touchStartY - touchEndY;

            // Only register horizontal swipes (not vertical scrolling)
            if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > SWIPE_THRESHOLD) {
                if (diffX > 0) {
                    navigateDay(1); // Swipe left  next day
                } else {
                    navigateDay(-1); // Swipe right  previous day
                }
            }
        }

        // Bottom sheet swipe down to close
        function setupBottomSheetGestures() {
            let sheetTouchStartY = 0;

            bottomSheet.addEventListener('touchstart', e => {
                sheetTouchStartY = e.changedTouches[0].screenY;
            }, { passive: true });

            bottomSheet.addEventListener('touchend', e => {
                const sheetTouchEndY = e.changedTouches[0].screenY;
                const diff = sheetTouchEndY - sheetTouchStartY;

                if (diff > 100) {
                    closeBottomSheet();
                }
            }, { passive: true });
        }

        // Data Persistence
        function saveData() {
            const data = {
                tasks: tasks,
                xp: totalXp,
                dailyTaskCounter: dailyTaskCounter,
                taskIdCounter: taskIdCounter,
                completions: taskCompletions
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        function loadData() {
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (!savedData) return;

            try {
                const data = JSON.parse(savedData);

                dailyTaskCounter = data.dailyTaskCounter || 0;
                taskIdCounter = data.taskIdCounter || 0;
                taskCompletions = data.completions || {};

                // Load tasks - handle migration from old format
                if (data.tasks && Array.isArray(data.tasks)) {
                    // Check if old format (tasks have dayIndex)
                    if (data.tasks.length > 0 && data.tasks[0].dayIndex !== undefined) {
                        // Migrate from old format
                        tasks = migrateOldTasks(data.tasks);
                    } else {
                        tasks = data.tasks;
                    }
                }

                // Recalculate XP from completions
                totalXp = recalculateXpFromCompletions();
                updateLevelDisplay();
            } catch (e) {
                console.error('Error loading saved data:', e);
            }
        }

        function migrateOldTasks(oldTasks) {
            const migratedTasks = [];
            const seenDailyIds = new Set();

            oldTasks.forEach(task => {
                // For recurring tasks, only add once
                if (task.dailyId) {
                    if (seenDailyIds.has(task.dailyId)) return;
                    seenDailyIds.add(task.dailyId);

                    migratedTasks.push({
                        id: task.id,
                        name: task.name,
                        type: task.pattern === 'daily' ? 'daily' : 'custom',
                        dailyId: task.dailyId,
                        pattern: task.pattern
                    });
                } else {
                    // One-time task
                    migratedTasks.push({
                        id: task.id,
                        name: task.name,
                        type: 'onetime',
                        date: task.fullDate || formatDateForInput(new Date())
                    });
                }
            });

            return migratedTasks;
        }

        function loadView() {
            const savedView = localStorage.getItem(VIEW_STORAGE_KEY);
            const isMobile = window.innerWidth < 600;

            if (savedView) {
                setView(savedView);
            } else {
                setView(isMobile ? 'day' : 'week');
            }
        }

        // Event Listeners Setup
        function setupEventListeners() {
            // Date navigation
            prevDateBtn.addEventListener('click', () => {
                if (currentView === 'month') {
                    changeMonth(-1);
                } else {
                    navigateDay(-1);
                }
            });

            nextDateBtn.addEventListener('click', () => {
                if (currentView === 'month') {
                    changeMonth(1);
                } else {
                    navigateDay(1);
                }
            });

            todayBtn.addEventListener('click', goToToday);

            // View toggle
            dayViewBtn.addEventListener('click', () => setView('day'));
            weekViewBtn.addEventListener('click', () => setView('week'));
            monthViewBtn.addEventListener('click', () => setView('month'));

            // FAB
            fabButton.addEventListener('click', () => {
                if (createTaskModal.classList.contains('active')) {
                    closeCreateTaskModal();
                } else {
                    openCreateTaskModal();
                }
            });

            // Modal
            modalCloseBtn.addEventListener('click', closeCreateTaskModal);
            createTaskModal.addEventListener('click', (e) => {
                if (e.target === createTaskModal) {
                    closeCreateTaskModal();
                }
            });

            modalTypeSelect.addEventListener('change', () => {
                const type = modalTypeSelect.value;
                modalDateField.style.display = type === 'onetime' ? 'block' : 'none';
                modalDayPickerField.style.display = type === 'custom' ? 'block' : 'none';
            });

            modalDayPicker.querySelectorAll('.modal-day-toggle').forEach(btn => {
                btn.addEventListener('click', () => {
                    btn.classList.toggle('selected');
                });
            });

            modalSubmitBtn.addEventListener('click', addTask);
            modalTaskInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addTask();
            });

            // Bottom sheet
            bottomSheetOverlay.addEventListener('click', closeBottomSheet);
            sheetCloseBtn.addEventListener('click', closeBottomSheet);

            // Swipe gestures
            setupSwipeGestures();
            setupBottomSheetGestures();
        }

        function changeMonth(delta) {
            viewingMonth += delta;
            if (viewingMonth > 11) {
                viewingMonth = 0;
                viewingYear++;
            } else if (viewingMonth < 0) {
                viewingMonth = 11;
                viewingYear--;
            }
            viewingDate = new Date(viewingYear, viewingMonth, 1);
            renderMonthView();
        }

        // Initialize
        function init() {
            loadData();
            setupEventListeners();
            loadView();
            updateDateDisplay();
        }

        init();
    </script>
</body>
</html>
