<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Life Gamified</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            background: #0a0a0a;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            color: #e5e5e5;
            padding: 0;
            padding-bottom: 5rem;
            overflow-x: hidden;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* Sticky Header */
        .sticky-header {
            position: sticky;
            top: 0;
            left: 0;
            right: 0;
            background: #0a0a0a;
            z-index: 100;
            padding: 1rem 1rem 0;
            margin: 0 -1rem;
            width: calc(100% + 2rem);
        }

        .sticky-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, #1a1a1a, transparent);
        }

        .main-content {
            padding-top: 0.75rem;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 0.75rem;
        }

        .app-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 0.25rem;
            letter-spacing: -0.02em;
        }

        .app-subtitle {
            color: #525252;
            font-size: 0.8rem;
            font-weight: 400;
        }

        /* Level Progress */
        .level-container {
            margin-top: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .level-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.8rem;
            color: #737373;
        }

        .level-badge {
            color: #a3a3a3;
            font-weight: 500;
        }

        .level-badge span {
            color: #ffffff;
            font-weight: 600;
        }

        .xp-text {
            color: #525252;
        }

        .progress-bar-container {
            width: 200px;
            height: 4px;
            background: #1a1a1a;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #60a5fa);
            border-radius: 2px;
            transition: width 0.3s ease;
            width: 0%;
        }

        /* Date Navigation */
        .date-nav {
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            margin: 0.75rem 0;
            padding: 0 3.5rem;
        }

        .date-nav-center {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .today-btn {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
        }

        .nav-arrow {
            width: 32px;
            height: 32px;
            background: transparent;
            border: 1px solid #262626;
            border-radius: 8px;
            color: #525252;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media (hover: hover) {
            .nav-arrow:hover {
                border-color: #404040;
                color: #a3a3a3;
                background: #141414;
            }
        }

        /* Elegant Date Display */
        .date-display-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            background: #0f0f0f;
            border: 1px solid #1a1a1a;
            border-radius: 10px;
            min-width: 140px;
        }

        /* Day View: Prominent single date */
        .date-badge {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.125rem;
        }

        .date-badge-month {
            font-size: 0.55rem;
            font-weight: 600;
            color: #3b82f6;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .date-badge-day {
            font-size: 1.5rem;
            font-weight: 700;
            color: #ffffff;
            line-height: 1;
        }

        .date-badge-weekday {
            font-size: 0.6rem;
            font-weight: 500;
            color: #525252;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Week/Month View: Simple text */
        .date-text {
            font-size: 0.9rem;
            font-weight: 500;
            color: #e5e5e5;
            text-align: center;
        }

        .date-text-sub {
            font-size: 0.65rem;
            color: #525252;
            margin-top: 0.125rem;
        }

        .today-btn {
            padding: 0.375rem 0.625rem;
            background: transparent;
            border: 1px solid #262626;
            border-radius: 6px;
            color: #525252;
            font-size: 0.65rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        @media (hover: hover) {
            .today-btn:hover {
                border-color: #404040;
                color: #a3a3a3;
                background: #141414;
            }
        }

        .today-btn.active {
            background: #3b82f6;
            border-color: #3b82f6;
            color: #ffffff;
        }

        /* View Toggle */
        .view-toggle-container {
            display: flex;
            justify-content: center;
            padding-bottom: 0.75rem;
        }

        .view-toggle {
            display: flex;
            background: #141414;
            border: 1px solid #262626;
            border-radius: 8px;
            padding: 4px;
            gap: 2px;
        }

        .view-btn {
            padding: 0.5rem 0.75rem;
            border: none;
            background: transparent;
            color: #525252;
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        @media (min-width: 400px) {
            .view-btn {
                padding: 0.5rem 1rem;
                font-size: 0.8rem;
            }
        }

        @media (hover: hover) {
            .view-btn:hover {
                color: #737373;
            }
        }

        .view-btn.active {
            background: #262626;
            color: #e5e5e5;
        }

        /* Day View - Optimized for fast switching */
        .day-view-container {
            display: none;
            content-visibility: auto;
        }

        .day-view-container.active {
            display: block;
        }

        .day-content {
            background: #0f0f0f;
            border: 1px solid #1a1a1a;
            border-radius: 12px;
            padding: 1rem;
            min-height: 300px;
        }

        .day-content.slide-left {
            animation: slideOutLeft 0.2s ease;
        }

        .day-content.slide-right {
            animation: slideOutRight 0.2s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(0);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOutLeft {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(-30px);
            }
        }

        @keyframes slideOutRight {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(30px);
            }
        }

        .day-tasks {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        /* Click-to-add area for Day view */
        .day-content {
            cursor: pointer;
        }

        .day-add-hint {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            margin-top: 0.5rem;
            border: 1px dashed #262626;
            border-radius: 8px;
            color: #333333;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }

        @media (hover: hover) {
            .day-add-hint:hover {
                border-color: #404040;
                color: #525252;
            }
        }

        /* Week View - Optimized for fast switching */
        .week-view-container {
            display: none;
            content-visibility: auto;
        }

        .week-view-container.active {
            display: block;
        }

        /* Week List (Mobile) - All 7 days vertical */
        .week-list {
            display: flex;
            flex-direction: column;
            gap: 0;
            background: #0f0f0f;
            border: 1px solid #1a1a1a;
            border-radius: 12px;
            overflow: hidden;
        }

        .week-day-section {
            border-bottom: 1px solid #1a1a1a;
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .week-day-section:last-child {
            border-bottom: none;
        }

        .week-day-section.today {
            background: rgba(59, 130, 246, 0.05);
        }

        @media (hover: hover) {
            .week-day-section:hover {
                background: #0e0e0e;
            }

            .week-day-section.today:hover {
                background: rgba(59, 130, 246, 0.08);
            }
        }

        .week-day-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 0.75rem;
            background: #0a0a0a;
        }

        .week-day-section.today .week-day-header {
            background: rgba(59, 130, 246, 0.08);
        }

        .week-day-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .week-day-name {
            font-size: 0.7rem;
            font-weight: 600;
            color: #525252;
            text-transform: uppercase;
            min-width: 2rem;
        }

        .week-day-section.today .week-day-name {
            color: #3b82f6;
        }

        .week-day-num {
            font-size: 0.9rem;
            font-weight: 600;
            color: #a3a3a3;
            min-width: 1.5rem;
            text-align: right;
            display: inline-block;
        }

        .week-day-section.today .week-day-num {
            color: #3b82f6;
        }

        .week-day-badge {
            font-size: 0.55rem;
            font-weight: 600;
            color: #3b82f6;
            background: rgba(59, 130, 246, 0.2);
            padding: 0.15rem 0.375rem;
            border-radius: 3px;
            text-transform: uppercase;
        }

        .week-task-count {
            font-size: 0.6rem;
            color: #525252;
            background: #1a1a1a;
            padding: 0.125rem 0.375rem;
            border-radius: 3px;
        }

        .week-empty-label {
            font-size: 0.65rem;
            color: #333333;
        }

        .week-add-indicator {
            font-size: 0.9rem;
            color: #333333;
            opacity: 0;
            transition: opacity 0.15s ease;
            margin-left: 0.5rem;
        }

        @media (hover: hover) {
            .week-day-section:hover .week-add-indicator {
                opacity: 1;
            }
        }

        .week-day-tasks {
            padding: 0.375rem 0.5rem 0.5rem;
        }

        .week-day-tasks .day-tasks {
            gap: 0.25rem;
        }

        /* Compact task items in week view */
        .week-day-tasks .task-item {
            display: flex;
            align-items: center;
            padding: 0.5rem 0.625rem;
            gap: 0.625rem;
            border-radius: 6px;
            animation: none;
        }

        .week-day-tasks .task-checkbox {
            width: 18px;
            height: 18px;
            border-width: 1.5px;
            border-radius: 4px;
            flex-shrink: 0;
            margin: 0;
        }

        .week-day-tasks .task-checkbox.checked::after {
            width: 9px;
            height: 5px;
            border-width: 1.5px;
        }

        .week-day-tasks .task-content {
            flex: 1;
            min-width: 0;
        }

        .week-day-tasks .task-name {
            font-size: 0.85rem;
            line-height: 1.3;
            text-align: left;
        }

        .week-day-tasks .task-badge {
            display: none;
        }

        .week-day-tasks .delete-button {
            width: 24px;
            height: 24px;
            font-size: 0.9rem;
            flex-shrink: 0;
            margin: 0;
        }

        /* Desktop: 7-column grid */
        .week-grid {
            display: none;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
        }

        .week-grid-day {
            background: #0f0f0f;
            border: 1px solid #1a1a1a;
            border-radius: 10px;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .week-grid-day.today {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.03);
        }

        .week-grid-header {
            padding: 0.5rem;
            background: #0a0a0a;
            text-align: center;
            border-bottom: 1px solid #1a1a1a;
        }

        .week-grid-day.today .week-grid-header {
            background: rgba(59, 130, 246, 0.1);
        }

        .week-grid-day-name {
            font-size: 0.6rem;
            font-weight: 600;
            color: #525252;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .week-grid-day.today .week-grid-day-name {
            color: #3b82f6;
        }

        .week-grid-day-num {
            font-size: 1rem;
            font-weight: 700;
            color: #a3a3a3;
            margin-top: 0.125rem;
        }

        .week-grid-day.today .week-grid-day-num {
            color: #3b82f6;
        }

        .week-grid-tasks {
            flex: 1;
            padding: 0.375rem;
            overflow-y: auto;
        }

        .week-grid-tasks .task-item {
            display: flex;
            align-items: center;
            padding: 0.375rem 0.5rem;
            gap: 0.375rem;
            margin-bottom: 0.25rem;
            border-radius: 4px;
            animation: none;
        }

        .week-grid-tasks .task-checkbox {
            width: 14px;
            height: 14px;
            border-width: 1.5px;
            border-radius: 3px;
            flex-shrink: 0;
            margin: 0;
        }

        .week-grid-tasks .task-checkbox.checked::after {
            width: 7px;
            height: 4px;
            border-width: 1.5px;
        }

        .week-grid-tasks .task-content {
            flex: 1;
            min-width: 0;
            display: flex;
            align-items: center;
        }

        .week-grid-tasks .task-name {
            font-size: 0.7rem;
            line-height: 1;
        }

        .week-grid-tasks .task-badge {
            display: none;
        }

        .week-grid-tasks .delete-button {
            width: 20px;
            height: 20px;
            font-size: 0.8rem;
            opacity: 0.5;
            flex-shrink: 0;
            margin: 0;
        }

        @media (hover: hover) {
            .week-grid-tasks .task-item:hover .delete-button {
                opacity: 1;
            }
        }

        .week-grid-empty {
            font-size: 0.65rem;
            color: #333333;
            text-align: center;
            padding: 1rem 0.5rem;
        }

        .week-grid-add {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.375rem;
            margin: 0.25rem;
            background: transparent;
            border: 1px dashed #262626;
            border-radius: 4px;
            color: #333333;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        @media (hover: hover) {
            .week-grid-add:hover {
                border-color: #404040;
                color: #525252;
            }
        }

        /* Responsive: Mobile list, Desktop grid */
        @media (max-width: 599px) {
            .week-list {
                display: flex;
            }
            .week-grid {
                display: none !important;
            }

            /* Hide navigation arrows on mobile for Day/Week views (swipe gestures exist) */
            body[data-view="day"] .nav-arrow,
            body[data-view="week"] .nav-arrow {
                display: none !important;
            }
        }

        @media (min-width: 600px) {
            .week-list {
                display: none;
            }
            .week-grid {
                display: grid !important;
            }
        }

        /* Month View - Optimized for fast switching */
        .month-container {
            display: none;
            content-visibility: auto;
        }

        .month-container.active {
            display: block;
        }

        /* Mobile Month List View - Compact */
        .month-list {
            display: flex;
            flex-direction: column;
            gap: 0;
            /* Optimize scroll performance */
            -webkit-overflow-scrolling: touch;
        }

        /* Month Header Separator */
        .month-header-separator {
            padding: 1rem 0.75rem 0.5rem;
            text-align: center;
            scroll-margin-top: 12rem;
        }

        .month-header-separator:first-child {
            padding-top: 0.5rem;
        }

        .month-header-title {
            font-size: 0.7rem;
            font-weight: 600;
            color: #525252;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .month-header-separator.current .month-header-title {
            color: #3b82f6;
        }

        /* Month Block Container */
        .month-block {
            background: #0f0f0f;
            border: 1px solid #1a1a1a;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 0.5rem;
            /* Optimize rendering during scroll */
            content-visibility: auto;
            contain-intrinsic-size: auto 400px;
        }

        /* Week Separator */
        .week-separator {
            height: 1px;
            background: #262626;
            margin: 0.25rem 0.75rem;
        }

        /* Compact date section with tasks */
        .month-date-section {
            background: #0a0a0a;
            border-bottom: 1px solid #1a1a1a;
            scroll-margin-top: 10rem;
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .month-date-section:last-child {
            border-bottom: none;
        }

        .month-date-section.today {
            background: rgba(59, 130, 246, 0.05);
        }

        /* Hover effect for all date sections */
        @media (hover: hover) {
            .month-date-section:hover {
                background: #0e0e0e;
            }

            .month-date-section:hover .month-date-header {
                background: #121212;
            }

            .month-date-section.today:hover {
                background: rgba(59, 130, 246, 0.08);
            }

            .month-date-section.today:hover .month-date-header {
                background: rgba(59, 130, 246, 0.12);
            }
        }

        .month-date-section:active {
            background: #111111;
        }

        .month-date-section.today:active {
            background: rgba(59, 130, 246, 0.1);
        }

        /* Add button indicator */
        .month-add-indicator {
            font-size: 0.9rem;
            color: #333333;
            margin-left: 0.5rem;
            opacity: 0;
            transition: opacity 0.15s ease;
        }

        @media (hover: hover) {
            .month-date-section:hover .month-add-indicator {
                opacity: 1;
            }
        }

        /* Compact header */
        .month-date-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 0.75rem;
            background: #0f0f0f;
        }

        .month-date-section.today .month-date-header {
            background: rgba(59, 130, 246, 0.1);
        }

        .month-date-title {
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .month-date-num {
            font-size: 0.9rem;
            font-weight: 600;
            color: #a3a3a3;
            min-width: 1.5rem;
            text-align: right;
            display: inline-block;
        }

        .month-date-section.today .month-date-num {
            color: #3b82f6;
        }

        .month-date-day {
            font-size: 0.7rem;
            font-weight: 500;
            color: #525252;
            text-transform: uppercase;
        }

        .month-date-section.today .month-date-day {
            color: #3b82f6;
        }

        .month-date-badge {
            font-size: 0.55rem;
            font-weight: 600;
            color: #3b82f6;
            background: rgba(59, 130, 246, 0.2);
            padding: 0.15rem 0.375rem;
            border-radius: 3px;
            display: none;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .month-date-section.today .month-date-badge {
            display: block;
        }

        /* Empty date - single compact line */
        .month-date-section.empty-section .month-date-header {
            background: transparent;
        }

        .month-date-section.empty-section .month-date-num {
            color: #404040;
        }

        .month-date-section.empty-section .month-date-day {
            color: #333333;
        }

        .month-empty-label {
            font-size: 0.65rem;
            color: #333333;
            margin-left: auto;
        }

        @media (hover: hover) {
            .month-date-section.empty-section:hover .month-empty-label {
                color: #525252;
            }
        }

        /* Compact task container */
        .month-date-tasks {
            padding: 0.375rem 0.5rem 0.5rem;
        }

        .month-date-tasks .day-tasks {
            gap: 0.25rem;
        }

        /* Compact task items in month view */
        .month-date-tasks .task-item {
            display: flex;
            align-items: center;
            padding: 0.5rem 0.625rem;
            gap: 0.625rem;
            border-radius: 6px;
            animation: none;
        }

        .month-date-tasks .task-checkbox {
            width: 18px;
            height: 18px;
            border-width: 1.5px;
            border-radius: 4px;
            flex-shrink: 0;
            margin: 0;
        }

        .month-date-tasks .task-checkbox.checked::after {
            width: 9px;
            height: 5px;
            border-width: 1.5px;
        }

        .month-date-tasks .task-content {
            flex: 1;
            min-width: 0;
        }

        .month-date-tasks .task-name {
            font-size: 0.85rem;
            line-height: 1.3;
            text-align: left;
        }

        .month-date-tasks .task-badge {
            display: none;
        }

        .month-date-tasks .delete-button {
            width: 24px;
            height: 24px;
            font-size: 0.9rem;
            flex-shrink: 0;
            margin: 0;
        }

        /* Hide add button in compact view (use FAB instead) */
        .month-date-add {
            display: none;
        }

        /* Task count badge for sections with tasks */
        .month-task-count {
            font-size: 0.6rem;
            color: #525252;
            background: #1a1a1a;
            padding: 0.125rem 0.375rem;
            border-radius: 3px;
            margin-left: auto;
        }

        /* Desktop Month Grid View */
        .month-grid {
            display: none;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            background: #1a1a1a;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #1a1a1a;
        }

        .month-weekday-header {
            background: #0f0f0f;
            padding: 0.5rem;
            text-align: center;
            font-size: 0.65rem;
            font-weight: 500;
            color: #525252;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .month-day {
            background: #0a0a0a;
            min-height: 90px;
            padding: 0.375rem;
            display: flex;
            flex-direction: column;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        @media (hover: hover) {
            .month-day:not(.empty):hover {
                background: #111111;
            }
        }

        .month-day.empty {
            background: #050505;
            cursor: default;
        }

        .month-day.today {
            background: #111118;
            border: 1px solid #3b82f6;
        }

        .month-day-number {
            font-size: 0.75rem;
            color: #525252;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .month-day.today .month-day-number {
            color: #3b82f6;
            font-weight: 600;
        }

        .month-day.other-month .month-day-number {
            color: #333333;
        }

        /* Desktop Grid Task Items */
        .month-task-preview {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.2rem 0.3rem;
            background: #141414;
            border-radius: 4px;
            margin-bottom: 2px;
            cursor: pointer;
            transition: all 0.2s ease;
            overflow: hidden;
            position: relative;
        }

        .month-task-preview:hover {
            background: #1a1a1a;
        }

        .month-task-preview:active {
            transform: scale(0.98);
        }

        .month-task-preview.completed {
            opacity: 0.6;
        }

        .month-task-checkbox {
            width: 12px;
            height: 12px;
            border: 1.5px solid #404040;
            border-radius: 2px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
        }

        /* Larger touch target for month view checkboxes */
        .month-task-checkbox::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 32px;
            height: 32px;
            border-radius: 50%;
        }

        @media (hover: hover) {
            .month-task-checkbox:hover {
                border-color: #525252;
            }
            .month-task-checkbox.checked:hover {
                background: #2563eb;
                border-color: #2563eb;
            }
        }

        .month-task-checkbox:active {
            transform: scale(0.85);
        }

        .month-task-checkbox.checked {
            background: #3b82f6;
            border-color: #3b82f6;
        }

        .month-task-checkbox.checked::after {
            content: '';
            width: 6px;
            height: 3px;
            border: 1.5px solid #ffffff;
            border-top: none;
            border-right: none;
            transform: rotate(-45deg) translateY(-0.5px);
        }

        .month-task-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #404040;
            flex-shrink: 0;
            display: none;
        }

        .month-task-preview.completed .month-task-dot {
            background: #3b82f6;
        }

        .month-task-text {
            font-size: 0.6rem;
            color: #a3a3a3;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }

        .month-task-preview.completed .month-task-text {
            color: #525252;
        }

        .month-task-delete {
            width: 14px;
            height: 14px;
            background: transparent;
            border: none;
            color: #404040;
            font-size: 0.7rem;
            cursor: pointer;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            opacity: 0;
            transition: all 0.2s ease;
            padding: 0;
        }

        .month-task-preview:hover .month-task-delete {
            opacity: 1;
        }

        .month-task-delete:hover {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .month-more-tasks {
            font-size: 0.55rem;
            color: #3b82f6;
            padding: 0.15rem 0.3rem;
            text-align: center;
            cursor: pointer;
        }

        .month-more-tasks:hover {
            text-decoration: underline;
        }

        /* Task Indicators (fallback/dots) */
        .task-indicators {
            display: flex;
            gap: 3px;
            margin-top: 4px;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 100%;
        }

        .task-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #404040;
        }

        .task-dot.completed {
            background: #3b82f6;
        }

        .task-count {
            font-size: 0.6rem;
            color: #525252;
            margin-top: 2px;
        }

        /* Responsive: Show grid on desktop, list on mobile */
        @media (max-width: 599px) {
            .month-list {
                display: flex;
            }
            .month-grid {
                display: none !important;
            }
        }

        @media (min-width: 600px) {
            .month-list {
                display: none;
            }
            .month-grid {
                display: grid !important;
            }
        }

        /* Desktop: 2-column month list layout option */
        @media (min-width: 800px) {
            .month-grid {
                gap: 3px;
            }

            .month-day {
                min-height: 100px;
            }

            .month-task-preview {
                padding: 0.25rem 0.4rem;
            }

            .month-task-text {
                font-size: 0.65rem;
            }
        }

        /* Task Items */
        .task-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: #141414;
            border: 1px solid #1a1a1a;
            border-radius: 8px;
            padding: 0.875rem 1rem;
            transition: all 0.2s ease;
            animation: taskSlideIn 0.25s ease;
            position: relative;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .task-item.completed {
            background: #181818;
        }

        @keyframes taskSlideIn {
            from {
                opacity: 0;
                transform: translateY(-8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (hover: hover) {
            .task-item:hover {
                border-color: #262626;
            }
        }

        .task-item:active {
            background: #1a1a1a;
        }

        .task-checkbox {
            width: 20px;
            height: 20px;
            border: 1.5px solid #404040;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
            cursor: pointer;
            position: relative;
        }

        /* Larger touch target for mobile (44x44px minimum) */
        .task-checkbox::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 44px;
            height: 44px;
            border-radius: 50%;
        }

        @media (hover: hover) {
            .task-checkbox:hover {
                border-color: #525252;
            }
            .task-checkbox.checked:hover {
                background: #2563eb;
                border-color: #2563eb;
            }
        }

        .task-checkbox:active {
            transform: scale(0.9);
        }

        .task-checkbox.checked {
            background: #3b82f6;
            border-color: #3b82f6;
        }

        .task-checkbox.checked::after {
            content: '';
            width: 10px;
            height: 6px;
            border: 2px solid #ffffff;
            border-top: none;
            border-right: none;
            transform: rotate(-45deg) translateY(-1px);
        }

        .task-content {
            flex: 1;
            min-width: 0;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .task-name {
            font-size: 0.95rem;
            color: #d4d4d4;
            transition: all 0.2s ease;
            word-break: break-word;
            overflow-wrap: break-word;
            line-height: 1.4;
            display: block;
        }

        .task-name.completed {
            color: #525252;
            opacity: 0.6;
        }

        .task-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.2rem;
            font-size: 0.65rem;
            color: #525252;
            margin-top: 0.25rem;
        }

        .task-badge svg {
            width: 10px;
            height: 10px;
        }

        .delete-button {
            width: 28px;
            height: 28px;
            background: transparent;
            border: none;
            color: #404040;
            font-size: 1rem;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            opacity: 0.5;
            pointer-events: auto;
            -webkit-tap-highlight-color: transparent;
        }

        /* Mobile: Always show delete button */
        .delete-button {
            opacity: 0.4;
        }

        /* Desktop: Show on hover */
        @media (hover: hover) {
            .delete-button {
                opacity: 0.3;
            }

            .task-item:hover .delete-button {
                opacity: 1;
            }

            .delete-button:hover {
                color: #ef4444;
                background: rgba(239, 68, 68, 0.1);
            }
        }

        /* Empty State */
        .empty-day {
            text-align: center;
            padding: 2rem;
            color: #333333;
            font-size: 0.9rem;
        }

        /* XP Popup Animation */
        .xp-popup {
            position: absolute;
            left: 36px;
            bottom: 100%;
            font-size: 0.75rem;
            font-weight: 600;
            pointer-events: none;
            animation: xpFloat 1s ease forwards;
            white-space: nowrap;
        }

        .xp-popup.gain {
            color: #3b82f6;
        }

        .xp-popup.lose {
            color: #ef4444;
        }

        @keyframes xpFloat {
            0% {
                opacity: 0;
                transform: translateY(8px);
            }
            20% {
                opacity: 1;
            }
            100% {
                opacity: 0;
                transform: translateY(-16px);
            }
        }

        /* FAB */
        .fab {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            width: 56px;
            height: 56px;
            background: #3b82f6;
            border: none;
            border-radius: 50%;
            color: #ffffff;
            font-size: 1.75rem;
            font-weight: 300;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        @media (hover: hover) {
            .fab:hover {
                transform: scale(1.05);
                box-shadow: 0 6px 16px rgba(59, 130, 246, 0.5);
            }
        }

        .fab:active {
            transform: scale(0.95);
        }

        .fab.open {
            transform: rotate(45deg);
        }

        /* Modal Overlay */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.15s ease;
        }

        .modal-overlay.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Task Creation Modal */
        .task-modal {
            background: #141414;
            border: 1px solid #262626;
            border-radius: 16px;
            width: calc(100% - 2rem);
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlide 0.2s ease;
            box-sizing: border-box;
            margin: 0 1rem;
        }

        @media (max-width: 359px) {
            .task-modal {
                width: calc(100% - 1rem);
                margin: 0 0.5rem;
                border-radius: 12px;
            }

            .modal-body {
                padding: 1rem;
            }

            .modal-header {
                padding: 0.875rem 1rem;
            }

            .modal-footer {
                padding: 0.875rem 1rem;
            }

            .modal-input,
            .modal-select,
            .modal-date-input {
                padding: 0.75rem;
                font-size: 0.95rem;
            }

            .modal-day-toggle {
                padding: 0.5rem 0.2rem;
                font-size: 0.7rem;
                min-width: 36px;
            }
        }

        @keyframes modalSlide {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #262626;
        }

        .modal-header span {
            font-size: 1rem;
            font-weight: 600;
            color: #e5e5e5;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            background: transparent;
            border: none;
            color: #737373;
            font-size: 1.25rem;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media (hover: hover) {
            .modal-close:hover {
                background: #262626;
                color: #e5e5e5;
            }
        }

        .modal-body {
            padding: 1.25rem;
        }

        .modal-field {
            margin-bottom: 1rem;
        }

        .modal-label {
            display: block;
            font-size: 0.8rem;
            font-weight: 500;
            color: #737373;
            margin-bottom: 0.5rem;
        }

        .modal-input {
            width: 100%;
            background: #0f0f0f;
            border: 1px solid #262626;
            border-radius: 8px;
            padding: 0.875rem 1rem;
            font-size: 1rem;
            color: #e5e5e5;
            outline: none;
            transition: all 0.2s ease;
        }

        .modal-input::placeholder {
            color: #525252;
        }

        .modal-input:focus {
            border-color: #3b82f6;
            background: #111111;
        }

        .modal-select {
            width: 100%;
            background: #0f0f0f;
            border: 1px solid #262626;
            border-radius: 8px;
            padding: 0.875rem 1rem;
            padding-right: 2rem;
            font-size: 1rem;
            color: #e5e5e5;
            outline: none;
            cursor: pointer;
            transition: all 0.2s ease;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23737373' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
        }

        .modal-select:focus {
            border-color: #3b82f6;
        }

        .modal-select option {
            background: #141414;
            color: #e5e5e5;
        }

        .modal-date-input {
            width: 100%;
            background: #0f0f0f;
            border: 1px solid #262626;
            border-radius: 8px;
            padding: 0.875rem 1rem;
            font-size: 1rem;
            color: #e5e5e5;
            outline: none;
            cursor: pointer;
            transition: all 0.2s ease;
            color-scheme: dark;
        }

        .modal-date-input:focus {
            border-color: #3b82f6;
        }

        /* Day Picker in Modal */
        .modal-day-picker {
            display: none;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .modal-day-picker.active {
            display: flex;
        }

        .modal-day-toggle {
            flex: 1;
            min-width: 40px;
            padding: 0.625rem 0.25rem;
            background: #0f0f0f;
            border: 1px solid #262626;
            border-radius: 8px;
            color: #525252;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
        }

        @media (hover: hover) {
            .modal-day-toggle:hover {
                border-color: #404040;
                color: #737373;
            }
        }

        .modal-day-toggle.selected {
            background: #3b82f6;
            border-color: #3b82f6;
            color: #ffffff;
        }

        .modal-footer {
            padding: 1rem 1.25rem;
            border-top: 1px solid #262626;
        }

        .modal-submit {
            width: 100%;
            padding: 0.875rem;
            background: #3b82f6;
            border: none;
            border-radius: 8px;
            color: #ffffff;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        @media (hover: hover) {
            .modal-submit:hover {
                background: #2563eb;
            }
        }

        /* Notes Textarea in Modal */
        .modal-textarea {
            width: 100%;
            background: #0f0f0f;
            border: 1px solid #262626;
            border-radius: 8px;
            padding: 0.875rem 1rem;
            font-size: 0.95rem;
            color: #e5e5e5;
            outline: none;
            transition: all 0.2s ease;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
            line-height: 1.5;
        }

        .modal-textarea::placeholder {
            color: #525252;
        }

        .modal-textarea:focus {
            border-color: #3b82f6;
            background: #111111;
        }

        .notes-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: #525252;
        }

        .notes-hint {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding-right: 1rem;
        }

        .notes-char-count {
            text-align: right;
            flex-shrink: 0;
        }

        .notes-char-count.near-limit {
            color: #f59e0b;
        }

        .notes-char-count.at-limit {
            color: #ef4444;
        }

        /* All task names are clickable for notes */
        .task-name {
            cursor: pointer;
            pointer-events: auto;
        }

        .month-task-text {
            cursor: pointer;
            pointer-events: auto;
        }

        /* Notes View Modal - Premium Design */
        .notes-modal {
            background: #171717;
            border: 1px solid #2a2a2a;
            border-radius: 20px;
            width: calc(100% - 2rem);
            max-width: 440px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            animation: notesModalIn 0.25s cubic-bezier(0.16, 1, 0.3, 1);
            box-sizing: border-box;
            margin: 0 1rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5),
                        0 0 0 1px rgba(255, 255, 255, 0.05);
            overflow: hidden;
        }

        @keyframes notesModalIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .notes-modal-header {
            padding: 1.25rem 1.5rem;
            background: #1a1a1a;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 1rem;
        }

        .notes-modal-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #f5f5f5;
            line-height: 1.4;
            word-break: break-word;
        }

        .notes-modal-close {
            width: 32px;
            height: 32px;
            background: #262626;
            border: none;
            color: #737373;
            font-size: 1.1rem;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        @media (hover: hover) {
            .notes-modal-close:hover {
                background: #333333;
                color: #e5e5e5;
            }
        }

        .notes-modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
            background: #141414;
        }

        .notes-modal-textarea {
            width: 100%;
            background: #0f0f0f;
            border: 1px solid #333333;
            border-radius: 10px;
            padding: 1rem;
            font-size: 0.95rem;
            color: #e5e5e5;
            outline: none;
            transition: border-color 0.2s ease;
            resize: vertical;
            min-height: 150px;
            font-family: inherit;
            line-height: 1.7;
        }

        .notes-modal-textarea:focus {
            border-color: #3b82f6;
        }

        .notes-modal-footer {
            padding: 1rem 1.5rem;
            background: #1a1a1a;
            display: flex;
            gap: 0.75rem;
        }

        .notes-modal-btn {
            flex: 1;
            padding: 0.875rem 1rem;
            border: none;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .notes-modal-btn:active {
            transform: scale(0.98);
        }

        .notes-modal-btn-secondary {
            background: #262626;
            color: #d4d4d4;
        }

        @media (hover: hover) {
            .notes-modal-btn-secondary:hover {
                background: #333333;
                color: #ffffff;
            }
        }

        .notes-modal-btn-primary {
            background: #3b82f6;
            color: #ffffff;
        }

        @media (hover: hover) {
            .notes-modal-btn-primary:hover {
                background: #2563eb;
            }
        }

        .modal-submit:active {
            transform: scale(0.98);
        }

        /* Delete Modal */
        .modal {
            background: #141414;
            border: 1px solid #262626;
            border-radius: 12px;
            padding: 1.25rem;
            max-width: 300px;
            width: 90%;
            animation: modalSlide 0.15s ease;
        }

        .modal-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #e5e5e5;
            margin-bottom: 0.375rem;
        }

        .modal-text {
            font-size: 0.8rem;
            color: #737373;
            margin-bottom: 1rem;
            line-height: 1.4;
        }

        .modal-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.375rem;
        }

        .modal-btn {
            padding: 0.625rem 0.875rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .modal-btn-primary {
            background: #1a1a1a;
            border-color: #262626;
            color: #ef4444;
        }

        @media (hover: hover) {
            .modal-btn-primary:hover {
                background: #262626;
            }
        }

        .modal-btn-secondary {
            background: #1a1a1a;
            border-color: #262626;
            color: #d4d4d4;
        }

        @media (hover: hover) {
            .modal-btn-secondary:hover {
                background: #262626;
            }
        }

        .modal-btn-cancel {
            background: transparent;
            color: #525252;
        }

        @media (hover: hover) {
            .modal-btn-cancel:hover {
                color: #737373;
            }
        }

        /* Bottom Sheet */
        .bottom-sheet-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 900;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .bottom-sheet-overlay.active {
            display: block;
            opacity: 1;
        }

        .bottom-sheet {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            background: #141414;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            z-index: 950;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            max-height: 70vh;
            display: flex;
            flex-direction: column;
        }

        .bottom-sheet.open {
            transform: translateY(0);
        }

        .sheet-handle {
            width: 40px;
            height: 4px;
            background: #404040;
            border-radius: 2px;
            margin: 12px auto;
        }

        .sheet-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.25rem 1rem;
            border-bottom: 1px solid #262626;
        }

        .sheet-date {
            font-size: 1rem;
            font-weight: 600;
            color: #e5e5e5;
        }

        .sheet-close {
            width: 32px;
            height: 32px;
            background: transparent;
            border: none;
            color: #737373;
            font-size: 1.25rem;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media (hover: hover) {
            .sheet-close:hover {
                background: #262626;
                color: #e5e5e5;
            }
        }

        .sheet-tasks {
            flex: 1;
            overflow-y: auto;
            padding: 1rem 1.25rem;
            padding-bottom: 2rem;
        }

        .sheet-add-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            width: 100%;
            padding: 0.875rem;
            background: #0f0f0f;
            border: 1px dashed #262626;
            border-radius: 8px;
            color: #525252;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 0.75rem;
        }

        @media (hover: hover) {
            .sheet-add-btn:hover {
                border-color: #404040;
                color: #737373;
            }
        }

        /* Category Indicator */
        .category-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        /* Week grid smaller indicator */
        .week-grid-tasks .category-indicator {
            width: 5px;
            height: 5px;
        }

        /* Month grid indicator */
        .month-task-preview .category-indicator {
            width: 4px;
            height: 4px;
        }

        /* Category Select in Modal */
        .modal-category-select {
            width: 100%;
            background: #0f0f0f;
            border: 1px solid #262626;
            border-radius: 8px;
            padding: 0.875rem 1rem;
            padding-right: 2rem;
            padding-left: 2.5rem;
            font-size: 1rem;
            color: #e5e5e5;
            outline: none;
            cursor: pointer;
            transition: all 0.2s ease;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23737373' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
        }

        .modal-category-select:focus {
            border-color: #3b82f6;
        }

        .modal-category-select option {
            background: #141414;
            color: #e5e5e5;
        }

        .category-select-wrapper {
            position: relative;
        }

        .category-select-indicator {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            width: 8px;
            height: 8px;
            border-radius: 50%;
            pointer-events: none;
        }

        /* Stats View - Optimized for fast switching */
        .stats-container {
            display: none;
            content-visibility: auto;
        }

        .stats-container.active {
            display: block;
        }

        /* Quick Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        @media (min-width: 600px) {
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .stat-card {
            background: #0a0a0a;
            border: 1px solid #1a1a1a;
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
            transition: border-color 0.2s ease;
        }

        @media (hover: hover) {
            .stat-card:hover {
                border-color: #333333;
            }
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #ffffff;
            line-height: 1.1;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.7rem;
            color: #525252;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Weekly Summary Section */
        .stats-section {
            background: #0a0a0a;
            border: 1px solid #1a1a1a;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            overflow: hidden;
            box-sizing: border-box;
        }

        .stats-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .stats-section-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #e5e5e5;
        }

        .stats-section-subtitle {
            font-size: 0.7rem;
            color: #525252;
        }

        /* Overall Progress Bar */
        .overall-progress {
            margin-bottom: 1.25rem;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .progress-text {
            font-size: 0.8rem;
            color: #a3a3a3;
        }

        .progress-percent {
            font-size: 0.75rem;
            color: #525252;
        }

        .stats-progress-bar {
            height: 8px;
            background: #1a1a1a;
            border-radius: 4px;
            overflow: hidden;
        }

        .stats-progress-fill {
            height: 100%;
            background: #e5e5e5;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* Category Breakdown */
        .category-breakdown {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            overflow: hidden;
        }

        .category-breakdown-title {
            font-size: 0.75rem;
            font-weight: 500;
            color: #737373;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
        }

        .category-stat {
            display: grid;
            grid-template-columns: 110px 1fr 40px;
            gap: 0.75rem;
            align-items: center;
            width: 100%;
        }

        .category-stat-left {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 0;
        }

        .category-stat-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .category-stat-name {
            font-size: 0.8rem;
            color: #a3a3a3;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .category-progress-wrapper {
            width: 100%;
            height: 8px;
            position: relative;
        }

        .category-progress-container {
            height: 100%;
            background: #1a1a1a;
            border-radius: 4px;
            overflow: hidden;
            box-sizing: border-box;
            position: absolute;
            left: 0;
            top: 0;
        }

        .category-progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .category-stat-count {
            font-size: 0.75rem;
            color: #737373;
            white-space: nowrap;
            text-align: right;
        }

        /* Desktop: Wider category name */
        @media (min-width: 500px) {
            .category-stat {
                grid-template-columns: 140px 1fr 45px;
            }
        }

        /* Empty state for stats */
        .stats-empty {
            text-align: center;
            padding: 2rem 1rem;
            color: #525252;
            font-size: 0.85rem;
        }

        /* Hide date nav in stats view */
        body[data-view="stats"] .date-nav {
            display: none;
        }

        /* Hide FAB in stats view */
        body[data-view="stats"] .fab {
            display: none;
        }

        /* Achievements Section */
        .achievements-section {
            margin-top: 1rem;
        }

        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        @media (min-width: 500px) {
            .achievements-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (min-width: 700px) {
            .achievements-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .achievement-card {
            background: #0a0a0a;
            border: 1px solid #1a1a1a;
            border-radius: 8px;
            padding: 0.75rem;
            transition: all 0.2s ease;
        }

        .achievement-card.unlocked {
            border-color: #505050;
            background: #111;
        }

        .achievement-card.locked {
            opacity: 1;
        }

        .achievement-header {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            margin-bottom: 0.25rem;
        }

        .achievement-check {
            color: #4CAF50;
            font-size: 0.75rem;
        }

        .achievement-name {
            font-size: 0.8rem;
            font-weight: 600;
            color: #525252;
        }

        .achievement-card.unlocked .achievement-name {
            color: #e5e5e5;
        }

        .achievement-req {
            font-size: 0.65rem;
            color: #404040;
            margin-bottom: 0.375rem;
        }

        .achievement-card.unlocked .achievement-req {
            color: #737373;
        }

        .achievement-xp {
            font-size: 0.7rem;
            font-weight: 600;
            color: #404040;
        }

        .achievement-card.unlocked .achievement-xp {
            color: #FFD700;
        }

        .achievement-date {
            font-size: 0.6rem;
            color: #404040;
            margin-top: 0.25rem;
        }

        .achievement-progress {
            font-size: 0.7rem;
            color: #525252;
            padding: 0.5rem 0;
            border-top: 1px solid #1a1a1a;
            margin-top: 0.5rem;
        }

        .achievement-progress-bar {
            height: 4px;
            background: #1a1a1a;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 0.375rem;
        }

        .achievement-progress-fill {
            height: 100%;
            background: #404040;
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .card-progress {
            margin-top: 0.5rem;
        }

        .card-progress-text {
            font-size: 0.6rem;
            color: #525252;
            margin-bottom: 0.25rem;
        }

        .card-progress-bar {
            height: 3px;
            background: #1a1a1a;
            border-radius: 2px;
            overflow: hidden;
        }

        .card-progress-fill {
            height: 100%;
            background: #525252;
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .achievements-reset-container {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid #1a1a1a;
            text-align: center;
        }

        .achievements-reset-btn {
            background: transparent;
            border: 1px solid #333;
            color: #525252;
            font-size: 0.7rem;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .achievements-reset-btn:hover {
            border-color: #525252;
            color: #737373;
        }

        /* Confirmation Modal */
        .confirm-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2100;
            align-items: center;
            justify-content: center;
        }

        .confirm-overlay.active {
            display: flex;
        }

        .confirm-modal {
            background: #111;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 1.5rem;
            max-width: 320px;
            width: 90%;
            text-align: center;
        }

        .confirm-title {
            font-size: 1rem;
            font-weight: 600;
            color: #e5e5e5;
            margin-bottom: 0.75rem;
        }

        .confirm-message {
            font-size: 0.8rem;
            color: #737373;
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }

        .confirm-buttons {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
        }

        .confirm-btn {
            padding: 0.6rem 1.25rem;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .confirm-btn-cancel {
            background: transparent;
            border: 1px solid #333;
            color: #737373;
        }

        .confirm-btn-cancel:hover {
            border-color: #525252;
            color: #a5a5a5;
        }

        .confirm-btn-confirm {
            background: #b91c1c;
            border: none;
            color: #fff;
        }

        .confirm-btn-confirm:hover {
            background: #dc2626;
        }

        /* Celebration Modal */
        .celebration-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }

        .celebration-overlay.active {
            display: flex;
        }

        .celebration-card {
            background: #141414;
            border: 1px solid #333333;
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            max-width: 300px;
            width: 90%;
            animation: celebrationPop 0.3s ease;
        }

        @keyframes celebrationPop {
            0% {
                opacity: 0;
                transform: scale(0.9);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .celebration-label {
            font-size: 0.7rem;
            font-weight: 600;
            color: #737373;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.5rem;
        }

        .celebration-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 0.375rem;
        }

        .celebration-req {
            font-size: 0.85rem;
            color: #737373;
            margin-bottom: 1rem;
        }

        .celebration-xp {
            font-size: 1.25rem;
            font-weight: 700;
            color: #FFD700;
        }

        /* Responsive */
        @media (min-width: 600px) {
            .container {
                max-width: 900px;
            }

            .sticky-header {
                padding: 1rem 1rem 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sticky-header">
            <header class="header">
                <h1 class="app-title">Life Gamified</h1>
                <p class="app-subtitle">Turn your daily habits into an adventure</p>
                <div class="level-container">
                    <div class="level-info">
                        <span class="level-badge">Level <span id="currentLevel">1</span></span>
                        <span class="xp-text"><span id="currentXp">0</span> / <span id="xpToNext">100</span> XP</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                </div>
            </header>

            <div class="date-nav" id="dateNav">
                <div class="date-nav-center">
                    <button type="button" class="nav-arrow" id="prevDate">&#8592;</button>
                    <div class="date-display-container" id="dateDisplayContainer">
                        <div class="date-badge" id="dateBadge">
                            <span class="date-badge-month" id="dateBadgeMonth">JAN</span>
                            <span class="date-badge-day" id="dateBadgeDay">15</span>
                            <span class="date-badge-weekday" id="dateBadgeWeekday">Wednesday</span>
                        </div>
                    </div>
                    <button type="button" class="nav-arrow" id="nextDate">&#8594;</button>
                </div>
                <button type="button" class="today-btn" id="todayBtn">Today</button>
            </div>

            <div class="view-toggle-container">
                <div class="view-toggle">
                    <button type="button" class="view-btn" id="dayViewBtn">Day</button>
                    <button type="button" class="view-btn" id="weekViewBtn">Week</button>
                    <button type="button" class="view-btn" id="monthViewBtn">Month</button>
                    <button type="button" class="view-btn" id="statsViewBtn">Stats</button>
                </div>
            </div>
        </div>

        <div class="main-content">
        <!-- Day View -->
        <div class="day-view-container" id="dayViewContainer">
            <div class="day-content" id="dayContent">
                <div class="day-tasks" id="dayTasks"></div>
            </div>
        </div>

        <!-- Week View -->
        <div class="week-view-container" id="weekViewContainer">
            <div class="week-list" id="weekList"></div>
            <div class="week-grid" id="weekGrid"></div>
        </div>

        <!-- Month View -->
        <div class="month-container" id="monthContainer">
            <div class="month-list" id="monthList"></div>
            <div class="month-grid" id="monthGrid"></div>
        </div>

        <!-- Stats View -->
        <div class="stats-container" id="statsContainer">
            <!-- Quick Stats Grid -->
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-value" id="statTotalCompleted">0</div>
                    <div class="stat-label">Tasks Completed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statStreak">0</div>
                    <div class="stat-label">Day Streak</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statCompletionRate">0%</div>
                    <div class="stat-label">Completion Rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statLevel">1</div>
                    <div class="stat-label">Level</div>
                </div>
            </div>

            <!-- Weekly Summary Section -->
            <div class="stats-section">
                <div class="stats-section-header">
                    <span class="stats-section-title">This Week</span>
                    <span class="stats-section-subtitle" id="weekDateRange">Jan 20 - Jan 26</span>
                </div>

                <!-- Overall Progress -->
                <div class="overall-progress">
                    <div class="progress-header">
                        <span class="progress-text" id="weekProgressText">0 of 0 tasks completed</span>
                        <span class="progress-percent" id="weekProgressPercent">0%</span>
                    </div>
                    <div class="stats-progress-bar">
                        <div class="stats-progress-fill" id="weekProgressFill" style="width: 0%;"></div>
                    </div>
                </div>

                <!-- Category Breakdown -->
                <div class="category-breakdown">
                    <div class="category-breakdown-title">By Category</div>
                    <div id="categoryBreakdown"></div>
                </div>
            </div>

            <!-- Achievements Section -->
            <div class="stats-section achievements-section">
                <div class="stats-section-header">
                    <span class="stats-section-title">Achievements</span>
                </div>

                <!-- Streak Achievements -->
                <div class="category-breakdown-title">Streak</div>
                <div class="achievements-grid" id="streakAchievements"></div>
                <div class="achievement-progress" id="streakProgress"></div>

                <!-- Completion Achievements -->
                <div class="category-breakdown-title" style="margin-top: 1rem;">Completion</div>
                <div class="achievements-grid" id="completionAchievements"></div>
                <div class="achievement-progress" id="completionProgress"></div>

                <!-- Reset Button (for testing) -->
                <div class="achievements-reset-container">
                    <button type="button" class="achievements-reset-btn" id="resetAchievementsBtn" onclick="showResetConfirmation()">Reset Achievements</button>
                </div>
            </div>
        </div>
        </div>
    </div>

    <!-- Celebration Modal -->
    <div class="celebration-overlay" id="celebrationOverlay">
        <div class="celebration-card">
            <div class="celebration-label">Achievement Unlocked!</div>
            <div class="celebration-name" id="celebrationName">Achievement</div>
            <div class="celebration-req" id="celebrationReq">Requirement</div>
            <div class="celebration-xp" id="celebrationXp">+100 XP</div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="confirm-overlay" id="confirmOverlay">
        <div class="confirm-modal">
            <div class="confirm-title">Reset Achievements?</div>
            <div class="confirm-message">This will lock all achievements and remove bonus XP. Your task completion progress will remain. This cannot be undone.</div>
            <div class="confirm-buttons">
                <button type="button" class="confirm-btn confirm-btn-cancel" id="confirmCancel" onclick="hideResetConfirmation()">Cancel</button>
                <button type="button" class="confirm-btn confirm-btn-confirm" id="confirmReset" onclick="resetAchievements()">Reset</button>
            </div>
        </div>
    </div>

    <!-- FAB -->
    <button type="button" class="fab" id="fabButton">+</button>

    <!-- Task Creation Modal -->
    <div class="modal-overlay" id="createTaskModal">
        <div class="task-modal">
            <div class="modal-header">
                <span>New Task</span>
                <button type="button" class="modal-close" id="modalCloseBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-field">
                    <label class="modal-label">Task Name</label>
                    <input type="text" class="modal-input" id="modalTaskInput" placeholder="What do you want to do?">
                </div>
                <div class="modal-field">
                    <label class="modal-label">Notes (optional)</label>
                    <textarea class="modal-textarea" id="modalNotesInput" placeholder="Add details, links, or reminders..." maxlength="500" rows="3"></textarea>
                    <div class="notes-meta">
                        <span class="notes-hint">Tip: Add links, bullet points, or context</span>
                        <span class="notes-char-count" id="notesCharCount">0/500</span>
                    </div>
                </div>
                <div class="modal-field">
                    <label class="modal-label">Category</label>
                    <div class="category-select-wrapper">
                        <div class="category-select-indicator" id="categoryIndicator" style="background: #9E9E9E;"></div>
                        <select class="modal-category-select" id="modalCategorySelect">
                            <option value="general">General</option>
                            <option value="health">Health & Fitness</option>
                            <option value="learning">Learning</option>
                            <option value="creative">Creative</option>
                            <option value="wellness">Wellness</option>
                            <option value="productivity">Productivity</option>
                            <option value="social">Social</option>
                        </select>
                    </div>
                </div>
                <div class="modal-field">
                    <label class="modal-label">Type</label>
                    <select class="modal-select" id="modalTypeSelect">
                        <option value="onetime">One-time</option>
                        <option value="daily">Daily</option>
                        <option value="custom">Custom Days</option>
                    </select>
                </div>
                <div class="modal-field" id="modalDateField">
                    <label class="modal-label">Date</label>
                    <input type="date" class="modal-date-input" id="modalDateInput">
                </div>
                <div class="modal-field" id="modalDayPickerField" style="display: none;">
                    <label class="modal-label">Select Days</label>
                    <div class="modal-day-picker active" id="modalDayPicker">
                        <button type="button" class="modal-day-toggle" data-day="0">Mon</button>
                        <button type="button" class="modal-day-toggle" data-day="1">Tue</button>
                        <button type="button" class="modal-day-toggle" data-day="2">Wed</button>
                        <button type="button" class="modal-day-toggle" data-day="3">Thu</button>
                        <button type="button" class="modal-day-toggle" data-day="4">Fri</button>
                        <button type="button" class="modal-day-toggle" data-day="5">Sat</button>
                        <button type="button" class="modal-day-toggle" data-day="6">Sun</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="modal-submit" id="modalSubmitBtn">Add Task</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal">
            <div class="modal-title" id="modalTitle">Delete Repeating Task</div>
            <div class="modal-text" id="modalText">This task repeats on multiple days. How would you like to delete it?</div>
            <div class="modal-buttons">
                <button type="button" class="modal-btn modal-btn-secondary" onclick="deleteThisDay()">Delete from this day only</button>
                <button type="button" class="modal-btn modal-btn-primary" onclick="deleteAllDays()">Delete from all days</button>
                <button type="button" class="modal-btn modal-btn-cancel" onclick="closeDeleteModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Notes Modal (Simplified) -->
    <div class="modal-overlay" id="notesModal">
        <div class="notes-modal">
            <div class="notes-modal-header">
                <div class="notes-modal-title" id="notesModalTitle">Task Name</div>
                <button type="button" class="notes-modal-close" id="notesModalClose">&times;</button>
            </div>
            <div class="notes-modal-body">
                <textarea class="notes-modal-textarea" id="notesModalTextarea" maxlength="500" rows="5" placeholder="Add notes, details, or reminders..."></textarea>
            </div>
            <div class="notes-modal-footer">
                <button type="button" class="notes-modal-btn notes-modal-btn-secondary" id="notesModalCancelBtn">Cancel</button>
                <button type="button" class="notes-modal-btn notes-modal-btn-primary" id="notesModalSaveBtn">Save</button>
            </div>
        </div>
    </div>

    <!-- Bottom Sheet -->
    <div class="bottom-sheet-overlay" id="bottomSheetOverlay"></div>
    <div class="bottom-sheet" id="bottomSheet">
        <div class="sheet-handle"></div>
        <div class="sheet-header">
            <span class="sheet-date" id="sheetDate">Wednesday, Jan 15</span>
            <button type="button" class="sheet-close" id="sheetCloseBtn">&times;</button>
        </div>
        <div class="sheet-tasks" id="sheetTasks"></div>
    </div>

    <script>
        // DOM Elements
        const currentLevelEl = document.getElementById('currentLevel');
        const currentXpEl = document.getElementById('currentXp');
        const xpToNextEl = document.getElementById('xpToNext');
        const progressBar = document.getElementById('progressBar');
        const prevDateBtn = document.getElementById('prevDate');
        const nextDateBtn = document.getElementById('nextDate');
        const todayBtn = document.getElementById('todayBtn');
        const dayViewBtn = document.getElementById('dayViewBtn');
        const weekViewBtn = document.getElementById('weekViewBtn');
        const monthViewBtn = document.getElementById('monthViewBtn');
        const statsViewBtn = document.getElementById('statsViewBtn');
        const dayViewContainer = document.getElementById('dayViewContainer');
        const weekViewContainer = document.getElementById('weekViewContainer');
        const monthContainer = document.getElementById('monthContainer');
        const statsContainer = document.getElementById('statsContainer');
        const statTotalCompleted = document.getElementById('statTotalCompleted');
        const statStreak = document.getElementById('statStreak');
        const statCompletionRate = document.getElementById('statCompletionRate');
        const statLevel = document.getElementById('statLevel');
        const weekDateRange = document.getElementById('weekDateRange');
        const weekProgressText = document.getElementById('weekProgressText');
        const weekProgressPercent = document.getElementById('weekProgressPercent');
        const weekProgressFill = document.getElementById('weekProgressFill');
        const categoryBreakdown = document.getElementById('categoryBreakdown');
        const streakAchievementsEl = document.getElementById('streakAchievements');
        const completionAchievementsEl = document.getElementById('completionAchievements');
        const streakProgressEl = document.getElementById('streakProgress');
        const completionProgressEl = document.getElementById('completionProgress');
        const celebrationOverlay = document.getElementById('celebrationOverlay');
        const celebrationName = document.getElementById('celebrationName');
        const celebrationReq = document.getElementById('celebrationReq');
        const celebrationXp = document.getElementById('celebrationXp');
        const dayContent = document.getElementById('dayContent');
        const dayTasks = document.getElementById('dayTasks');
        const weekList = document.getElementById('weekList');
        const weekGrid = document.getElementById('weekGrid');
        const monthGrid = document.getElementById('monthGrid');
        const monthList = document.getElementById('monthList');
        const dateDisplayContainer = document.getElementById('dateDisplayContainer');
        const dateBadge = document.getElementById('dateBadge');
        const dateBadgeMonth = document.getElementById('dateBadgeMonth');
        const dateBadgeDay = document.getElementById('dateBadgeDay');
        const dateBadgeWeekday = document.getElementById('dateBadgeWeekday');
        const fabButton = document.getElementById('fabButton');
        const createTaskModal = document.getElementById('createTaskModal');
        const modalCloseBtn = document.getElementById('modalCloseBtn');
        const modalTaskInput = document.getElementById('modalTaskInput');
        const modalCategorySelect = document.getElementById('modalCategorySelect');
        const categoryIndicator = document.getElementById('categoryIndicator');
        const modalTypeSelect = document.getElementById('modalTypeSelect');
        const modalDateInput = document.getElementById('modalDateInput');
        const modalDateField = document.getElementById('modalDateField');
        const modalDayPickerField = document.getElementById('modalDayPickerField');
        const modalDayPicker = document.getElementById('modalDayPicker');
        const modalSubmitBtn = document.getElementById('modalSubmitBtn');
        const modalNotesInput = document.getElementById('modalNotesInput');
        const notesCharCount = document.getElementById('notesCharCount');
        const notesModal = document.getElementById('notesModal');
        const notesModalTitle = document.getElementById('notesModalTitle');
        const notesModalTextarea = document.getElementById('notesModalTextarea');
        const notesModalClose = document.getElementById('notesModalClose');
        const notesModalCancelBtn = document.getElementById('notesModalCancelBtn');
        const notesModalSaveBtn = document.getElementById('notesModalSaveBtn');
        const deleteModal = document.getElementById('deleteModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalText = document.getElementById('modalText');
        const bottomSheetOverlay = document.getElementById('bottomSheetOverlay');
        const bottomSheet = document.getElementById('bottomSheet');
        const sheetDate = document.getElementById('sheetDate');
        const sheetTasks = document.getElementById('sheetTasks');
        const sheetCloseBtn = document.getElementById('sheetCloseBtn');
        const dateNav = document.getElementById('dateNav');
        const resetAchievementsBtn = document.getElementById('resetAchievementsBtn');
        const confirmOverlay = document.getElementById('confirmOverlay');
        const confirmCancel = document.getElementById('confirmCancel');
        const confirmReset = document.getElementById('confirmReset');

        // State
        let totalXp = 0;
        let dailyTaskCounter = 0;
        let taskIdCounter = 0;
        let pendingDeleteTask = null;
        let pendingDeleteContext = null;
        let currentView = 'day';
        let viewingDate = new Date();
        let viewingMonth = new Date().getMonth();
        let viewingYear = new Date().getFullYear();
        let selectedSheetDate = null;
        let tasks = []; // Master task list
        let taskCompletions = {}; // Track completions by date

        // Swipe tracking
        let touchStartX = 0;
        let touchStartY = 0;
        let touchEndX = 0;
        let touchEndY = 0;
        const SWIPE_THRESHOLD = 50;

        // Constants
        const STORAGE_KEY = 'lifeGamifiedData';
        const VIEW_STORAGE_KEY = 'lifeGamifiedView';
        const XP_PER_LEVEL = 100;
        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        const dayAbbrev = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                           'July', 'August', 'September', 'October', 'November', 'December'];

        const repeatIcon = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 1l4 4-4 4"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><path d="M7 23l-4-4 4-4"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>`;

        // Category Colors
        const CATEGORY_COLORS = {
            general: '#9E9E9E',
            health: '#4CAF50',
            learning: '#2196F3',
            creative: '#9C27B0',
            wellness: '#00BCD4',
            productivity: '#FF9800',
            social: '#E91E63'
        };

        function getCategoryColor(category) {
            return CATEGORY_COLORS[category] || CATEGORY_COLORS.general;
        }

        // Achievement Definitions
        const ACHIEVEMENTS = {
            streak: [
                { id: 'streak_3', name: 'Spark', requirement: '3-day streak', threshold: 3, xp: 50 },
                { id: 'streak_7', name: 'On Fire', requirement: '7-day streak', threshold: 7, xp: 100 },
                { id: 'streak_14', name: 'Blazing', requirement: '14-day streak', threshold: 14, xp: 200 },
                { id: 'streak_30', name: 'Unstoppable', requirement: '30-day streak', threshold: 30, xp: 500 },
                { id: 'streak_100', name: 'Legendary', requirement: '100-day streak', threshold: 100, xp: 1000 }
            ],
            completion: [
                { id: 'complete_1', name: 'First Steps', requirement: '1 task completed', threshold: 1, xp: 10 },
                { id: 'complete_10', name: 'Getting Started', requirement: '10 tasks completed', threshold: 10, xp: 50 },
                { id: 'complete_50', name: 'Consistent', requirement: '50 tasks completed', threshold: 50, xp: 200 },
                { id: 'complete_100', name: 'Centurion', requirement: '100 tasks completed', threshold: 100, xp: 500 },
                { id: 'complete_500', name: 'Task Master', requirement: '500 tasks completed', threshold: 500, xp: 2000 }
            ]
        };

        // Unlocked achievements stored by id with unlock date
        let unlockedAchievements = {};

        // Utility Functions
        function getTodayIndex() {
            const jsDay = new Date().getDay();
            return jsDay === 0 ? 6 : jsDay - 1;
        }

        function getWeekdayFromDate(date) {
            const jsDay = date.getDay();
            return jsDay === 0 ? 6 : jsDay - 1;
        }

        function formatDateForInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDateForDisplay(date) {
            const dayName = days[getWeekdayFromDate(date)];
            const monthName = monthNames[date.getMonth()];
            return `${dayName}, ${monthName} ${date.getDate()}`;
        }

        function formatDateShort(date) {
            const monthShort = monthNames[date.getMonth()].slice(0, 3);
            return `${monthShort} ${date.getDate()}`;
        }

        function getWeekDates(centerDate) {
            const weekday = getWeekdayFromDate(centerDate);
            const weekDates = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(centerDate);
                date.setDate(centerDate.getDate() - weekday + i);
                weekDates.push(date);
            }
            return weekDates;
        }

        function isSameDay(date1, date2) {
            return formatDateForInput(date1) === formatDateForInput(date2);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getPatternLabel(pattern) {
            if (!pattern) return 'Daily';
            if (pattern === 'daily') return 'Daily';

            const indices = pattern.split(',').map(Number);
            if (indices.length === 7) return 'Daily';
            if (indices.length === 5 && indices.join(',') === '0,1,2,3,4') return 'Weekdays';
            if (indices.length === 2 && indices.join(',') === '5,6') return 'Weekends';

            return indices.map(i => dayAbbrev[i]).join(', ');
        }

        // Completion Tracking
        function isTaskCompletedForDate(taskId, dateStr) {
            return taskCompletions[taskId]?.[dateStr] === true;
        }

        function setTaskCompletedForDate(taskId, dateStr, completed) {
            if (!taskCompletions[taskId]) {
                taskCompletions[taskId] = {};
            }
            if (completed) {
                taskCompletions[taskId][dateStr] = true;
            } else {
                delete taskCompletions[taskId][dateStr];
            }
        }

        function recalculateXpFromCompletions() {
            let calculatedXp = 0;
            for (const taskId in taskCompletions) {
                for (const dateStr in taskCompletions[taskId]) {
                    if (taskCompletions[taskId][dateStr] === true) {
                        calculatedXp += 10;
                    }
                }
            }
            return calculatedXp;
        }

        // Level System
        function getLevel(xp) {
            return Math.floor(xp / XP_PER_LEVEL) + 1;
        }

        function getXpInCurrentLevel(xp) {
            return xp % XP_PER_LEVEL;
        }

        function updateLevelDisplay() {
            const level = getLevel(totalXp);
            const xpInLevel = getXpInCurrentLevel(totalXp);
            const progress = (xpInLevel / XP_PER_LEVEL) * 100;

            currentLevelEl.textContent = level;
            currentXpEl.textContent = xpInLevel;
            xpToNextEl.textContent = XP_PER_LEVEL;
            progressBar.style.width = progress + '%';
        }

        // Task Data Functions
        function getTasksForDate(date) {
            const dateStr = formatDateForInput(date);
            const weekdayIndex = getWeekdayFromDate(date);

            return tasks.filter(task => {
                if (task.type === 'daily') {
                    return true;
                } else if (task.type === 'custom') {
                    const taskDays = task.pattern.split(',').map(Number);
                    return taskDays.includes(weekdayIndex);
                } else {
                    // One-time task
                    return task.date === dateStr;
                }
            }).map(task => {
                const completionKey = task.dailyId || task.id;
                const completionDate = task.type === 'onetime' ? task.date : dateStr;
                return {
                    ...task,
                    completed: isTaskCompletedForDate(completionKey, completionDate)
                };
            });
        }

        // Date Navigation
        function navigateDay(delta) {
            const oldDate = new Date(viewingDate);
            viewingDate.setDate(viewingDate.getDate() + delta);

            // Update month/year if needed
            viewingMonth = viewingDate.getMonth();
            viewingYear = viewingDate.getFullYear();

            updateDateDisplay();

            if (currentView === 'day') {
                // Animate transition
                const direction = delta > 0 ? 'left' : 'right';
                dayContent.classList.add(`slide-${direction}`);
                setTimeout(() => {
                    dayContent.classList.remove(`slide-${direction}`);
                    renderDayView();
                }, 150);
            } else if (currentView === 'week') {
                // Check if we moved to a different week
                const oldWeekStart = getWeekDates(oldDate)[0];
                const newWeekStart = getWeekDates(viewingDate)[0];
                if (!isSameDay(oldWeekStart, newWeekStart)) {
                    renderWeekView();
                } else {
                    syncWeekStrip();
                    scrollCarouselToDay();
                }
            }
        }

        function goToToday() {
            viewingDate = new Date();
            viewingMonth = viewingDate.getMonth();
            viewingYear = viewingDate.getFullYear();
            updateDateDisplay();

            if (currentView === 'month') {
                // Always re-render grid view on desktop
                renderMonthGridView();

                // For mobile: Check if today's month is already loaded
                const todaySection = monthList.querySelector('.month-date-section.today');
                if (todaySection) {
                    todaySection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    renderMonthListView();
                    // Scroll to current month after render
                    setTimeout(() => {
                        const newTodaySection = monthList.querySelector('.month-date-section.today');
                        if (newTodaySection) {
                            newTodaySection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }, 100);
                }
            } else if (currentView === 'week') {
                // Re-render week view centered on today
                renderWeekView();
                // Scroll to today in the week list
                setTimeout(() => {
                    const todaySection = weekList.querySelector('.week-day-section.today');
                    if (todaySection) {
                        todaySection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 50);
            } else {
                renderCurrentView();
            }
        }

        function updateDateDisplay() {
            // Clear container and rebuild based on view
            dateDisplayContainer.innerHTML = '';

            if (currentView === 'day') {
                // Day View: Prominent badge with month, day number, weekday
                const badge = document.createElement('div');
                badge.className = 'date-badge';
                badge.innerHTML = `
                    <span class="date-badge-month">${monthNames[viewingDate.getMonth()].slice(0, 3)}</span>
                    <span class="date-badge-day">${viewingDate.getDate()}</span>
                    <span class="date-badge-weekday">${days[getWeekdayFromDate(viewingDate)]}</span>
                `;
                dateDisplayContainer.appendChild(badge);
            } else if (currentView === 'week') {
                // Week View: Show week range
                const weekDates = getWeekDates(viewingDate);
                const startDate = weekDates[0];
                const endDate = weekDates[6];

                const textDiv = document.createElement('div');
                textDiv.className = 'date-text';

                const startMonth = monthNames[startDate.getMonth()].slice(0, 3);
                const endMonth = monthNames[endDate.getMonth()].slice(0, 3);

                if (startDate.getMonth() === endDate.getMonth()) {
                    textDiv.textContent = `${startMonth} ${startDate.getDate()} - ${endDate.getDate()}`;
                } else {
                    textDiv.textContent = `${startMonth} ${startDate.getDate()} - ${endMonth} ${endDate.getDate()}`;
                }

                const subDiv = document.createElement('div');
                subDiv.className = 'date-text-sub';
                subDiv.textContent = startDate.getFullYear();

                textDiv.appendChild(subDiv);
                dateDisplayContainer.appendChild(textDiv);
            } else {
                // Month View: Month and year
                const textDiv = document.createElement('div');
                textDiv.className = 'date-text';
                textDiv.textContent = `${monthNames[viewingMonth]} ${viewingYear}`;
                dateDisplayContainer.appendChild(textDiv);
            }

            // Highlight Today button if viewing today
            const isToday = isSameDay(viewingDate, new Date());
            todayBtn.classList.toggle('active', isToday);
        }

        // View Management - Optimized for fast switching
        let lastRenderedView = null;
        let viewRenderTimeout = null;

        function setView(view) {
            // Cancel any pending render
            if (viewRenderTimeout) {
                cancelAnimationFrame(viewRenderTimeout);
                viewRenderTimeout = null;
            }

            currentView = view;

            // Update data attribute for CSS (used for arrow visibility on mobile)
            document.body.dataset.view = view;

            // For Month view, update viewingMonth/viewingYear FIRST
            if (view === 'month') {
                viewingMonth = viewingDate.getMonth();
                viewingYear = viewingDate.getFullYear();
            }

            // Update header IMMEDIATELY before rendering (not for stats view)
            if (view !== 'stats') {
                updateDateDisplay();
            }

            // Batch all classList operations for faster switching
            const containers = [dayViewContainer, weekViewContainer, monthContainer, statsContainer];
            const buttons = [dayViewBtn, weekViewBtn, monthViewBtn, statsViewBtn];
            const viewMap = { day: 0, week: 1, month: 2, stats: 3 };
            const viewIndex = viewMap[view];

            // Single pass to update all classes
            containers.forEach((c, i) => c.classList.toggle('active', i === viewIndex));
            buttons.forEach((b, i) => b.classList.toggle('active', i === viewIndex));

            // Defer rendering to next frame for smoother transitions
            viewRenderTimeout = requestAnimationFrame(() => {
                if (view === 'day') {
                    renderDayView();
                } else if (view === 'week') {
                    renderWeekView();
                } else if (view === 'stats') {
                    renderStatsView();
                } else {
                    renderMonthView();
                }
                lastRenderedView = view;
            });

            localStorage.setItem(VIEW_STORAGE_KEY, view);
        }

        function renderCurrentView() {
            if (currentView === 'day') {
                renderDayView();
            } else if (currentView === 'week') {
                renderWeekView();
            } else if (currentView === 'stats') {
                renderStatsView();
            } else {
                renderMonthView();
            }
        }

        // Update only a specific date section in Month view (avoids scroll reset)
        function updateMonthDateSection(dateStr) {
            const section = monthList.querySelector(`.month-date-section[data-date="${dateStr}"]`);
            if (!section) return false;

            // Parse the date
            const [year, month, day] = dateStr.split('-').map(Number);
            const date = new Date(year, month - 1, day);
            const tasksForDay = getTasksForDate(date);
            const hasNoTasks = tasksForDay.length === 0;

            // Update section classes
            section.classList.toggle('empty-section', hasNoTasks);

            // Update task count badge
            const countBadge = section.querySelector('.month-task-count');
            const emptyLabel = section.querySelector('.month-empty-label');
            const header = section.querySelector('.month-date-header');
            const isToday = section.classList.contains('today');

            if (hasNoTasks) {
                // Remove count badge if exists
                if (countBadge) countBadge.remove();
                // Add empty label if not today and doesn't exist
                if (!isToday && !emptyLabel) {
                    const addIndicator = header.querySelector('.month-add-indicator');
                    const newEmptyLabel = document.createElement('span');
                    newEmptyLabel.className = 'month-empty-label';
                    newEmptyLabel.textContent = 'No tasks';
                    header.insertBefore(newEmptyLabel, addIndicator);
                }
            } else {
                // Remove empty label if exists
                if (emptyLabel) emptyLabel.remove();
                // Update or create count badge
                if (countBadge) {
                    countBadge.textContent = `${tasksForDay.length} task${tasksForDay.length > 1 ? 's' : ''}`;
                } else {
                    const addIndicator = header.querySelector('.month-add-indicator');
                    const newCountBadge = document.createElement('span');
                    newCountBadge.className = 'month-task-count';
                    newCountBadge.textContent = `${tasksForDay.length} task${tasksForDay.length > 1 ? 's' : ''}`;
                    header.insertBefore(newCountBadge, addIndicator);
                }
            }

            // Update tasks container
            let tasksContainer = section.querySelector('.month-date-tasks');

            if (hasNoTasks) {
                // Remove tasks container if exists
                if (tasksContainer) tasksContainer.remove();
            } else {
                // Create container if doesn't exist
                if (!tasksContainer) {
                    tasksContainer = document.createElement('div');
                    tasksContainer.className = 'month-date-tasks';
                    section.appendChild(tasksContainer);
                }

                // Rebuild task list
                tasksContainer.innerHTML = '';
                const tasksList = document.createElement('div');
                tasksList.className = 'day-tasks';

                tasksForDay.forEach(task => {
                    const taskEl = createTaskElement(task, dateStr);
                    tasksList.appendChild(taskEl);
                });

                tasksContainer.appendChild(tasksList);
            }

            return true;
        }

        // Day View
        function renderDayView() {
            const dateStr = formatDateForInput(viewingDate);
            const tasksForDay = getTasksForDate(viewingDate);

            dayTasks.innerHTML = '';

            if (tasksForDay.length === 0) {
                dayTasks.innerHTML = '<div class="empty-day">No tasks for this day</div>';
            } else {
                tasksForDay.forEach(task => {
                    const taskEl = createTaskElement(task, dateStr);
                    dayTasks.appendChild(taskEl);
                });
            }

            // Add hint for click-to-add
            const addHint = document.createElement('div');
            addHint.className = 'day-add-hint';
            addHint.textContent = '+ Tap to add task';
            addHint.addEventListener('click', (e) => {
                e.stopPropagation();
                openCreateTaskModal(dateStr);
            });
            dayTasks.appendChild(addHint);
        }

        function createTaskElement(task, dateStr) {
            const taskItem = document.createElement('div');
            taskItem.className = 'task-item' + (task.completed ? ' completed' : '');
            taskItem.dataset.taskId = task.id;
            taskItem.dataset.dateStr = dateStr;

            if (task.dailyId) {
                taskItem.dataset.dailyId = task.dailyId;
            }
            if (task.pattern) {
                taskItem.dataset.pattern = task.pattern;
            }
            if (task.type) {
                taskItem.dataset.type = task.type;
            }

            let badge = '';
            if (task.type === 'daily' || task.type === 'custom') {
                badge = `<div class="task-badge">${repeatIcon}</div>`;
            }

            const checkedClass = task.completed ? ' checked' : '';
            const completedClass = task.completed ? ' completed' : '';
            const categoryColor = getCategoryColor(task.category);

            taskItem.innerHTML = `
                <div class="task-checkbox${checkedClass}"></div>
                <div class="category-indicator" style="background: ${categoryColor};"></div>
                <div class="task-content">
                    <span class="task-name${completedClass}">${escapeHtml(task.name)}</span>
                    ${badge}
                </div>
                <button type="button" class="delete-button">&times;</button>
            `;

            // Event listeners - checkbox only toggles completion
            const checkbox = taskItem.querySelector('.task-checkbox');
            checkbox.addEventListener('click', function(e) {
                e.stopPropagation();
                toggleTask(taskItem);
            });

            const deleteBtn = taskItem.querySelector('.delete-button');
            deleteBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                handleDeleteTask(taskItem);
            });

            // Task name click handler - opens notes modal for all tasks
            const taskNameEl = taskItem.querySelector('.task-name');
            taskNameEl.addEventListener('click', function(e) {
                e.stopPropagation();
                openNotesModal(task.id);
            });

            return taskItem;
        }

        function toggleTask(taskItem) {
            const taskId = taskItem.dataset.taskId;
            const dateStr = taskItem.dataset.dateStr;
            const dailyId = taskItem.dataset.dailyId;

            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            const completionKey = dailyId || taskId;
            const completionDate = task.type === 'onetime' ? task.date : dateStr;
            const wasCompleted = isTaskCompletedForDate(completionKey, completionDate);
            const isNowCompleted = !wasCompleted;

            setTaskCompletedForDate(completionKey, completionDate, isNowCompleted);

            // Update UI
            const checkbox = taskItem.querySelector('.task-checkbox');
            const taskName = taskItem.querySelector('.task-name');
            checkbox.classList.toggle('checked', isNowCompleted);
            taskName.classList.toggle('completed', isNowCompleted);
            taskItem.classList.toggle('completed', isNowCompleted);

            // XP popup
            const popup = document.createElement('span');
            popup.className = 'xp-popup ' + (isNowCompleted ? 'gain' : 'lose');
            popup.textContent = (isNowCompleted ? '+' : '-') + '10 XP';
            taskItem.appendChild(popup);
            setTimeout(() => popup.remove(), 1000);

            // Update XP
            totalXp += isNowCompleted ? 10 : -10;
            if (totalXp < 0) totalXp = 0;
            updateLevelDisplay();

            saveData();

            // Check achievements when completing a task
            if (isNowCompleted) {
                checkAchievements();
            }
        }

        function handleDeleteTask(taskItem) {
            const taskId = taskItem.dataset.taskId;
            const dailyId = taskItem.dataset.dailyId;
            const dateStr = taskItem.dataset.dateStr;
            const type = taskItem.dataset.type;

            if (dailyId || type === 'daily' || type === 'custom') {
                // Recurring task - show modal
                pendingDeleteTask = taskItem;
                pendingDeleteContext = { taskId, dailyId, dateStr, type };

                const task = tasks.find(t => t.id === taskId);
                const label = getPatternLabel(task?.pattern);

                modalTitle.textContent = 'Delete Repeating Task';
                modalText.textContent = `This task repeats (${label}). How would you like to delete it?`;
                deleteModal.classList.add('active');
            } else {
                // One-time task - delete directly
                deleteTaskCompletely(taskId);
            }
        }

        function deleteThisDay() {
            if (!pendingDeleteContext) return;

            const { taskId, dailyId, dateStr } = pendingDeleteContext;
            const completionKey = dailyId || taskId;

            // Remove XP if completed for this date
            if (isTaskCompletedForDate(completionKey, dateStr)) {
                totalXp -= 10;
                if (totalXp < 0) totalXp = 0;
            }

            // Remove completion for this date
            if (taskCompletions[completionKey]) {
                delete taskCompletions[completionKey][dateStr];
            }

            // Verify XP by recalculating from remaining completions + achievements
            const calculatedXp = recalculateXpFromCompletions() + calculateAchievementXp();
            if (totalXp !== calculatedXp) {
                totalXp = calculatedXp;
            }

            updateLevelDisplay();
            saveData();

            // In Month view, update only the affected date section to avoid scroll reset
            if (currentView === 'month' && dateStr) {
                if (!updateMonthDateSection(dateStr)) {
                    renderCurrentView();
                }
            } else {
                renderCurrentView();
            }
            closeDeleteModal();
        }

        function deleteAllDays() {
            if (!pendingDeleteContext) return;

            const { taskId, dailyId } = pendingDeleteContext;
            const completionKey = dailyId || taskId;

            // For Month view, save scroll position before deletion
            const isMonthView = currentView === 'month';
            const savedScrollY = isMonthView ? window.scrollY : 0;

            // Skip render in deleteTaskCompletely for Month view - we'll handle it with scroll preservation
            deleteTaskCompletely(taskId, completionKey, isMonthView);

            // For Month view, render with scroll position preservation
            if (isMonthView) {
                renderCurrentView();
                requestAnimationFrame(() => {
                    window.scrollTo(0, savedScrollY);
                });
            }

            closeDeleteModal();
        }

        function deleteTaskCompletely(taskId, completionKey = null, skipRender = false) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            // Save task date for one-time tasks before deletion (for targeted Month view update)
            const isOneTimeTask = task.type === 'onetime';
            const taskDate = isOneTimeTask ? task.date : null;

            const key = completionKey || task.dailyId || taskId;

            // Remove XP for all completed dates
            if (taskCompletions[key]) {
                const completedCount = Object.values(taskCompletions[key]).filter(v => v === true).length;
                if (completedCount > 0) {
                    totalXp -= completedCount * 10;
                    if (totalXp < 0) totalXp = 0;
                }
                delete taskCompletions[key];
            }

            // Also check if task ID has separate completions (for edge cases)
            if (key !== taskId && taskCompletions[taskId]) {
                const completedCount = Object.values(taskCompletions[taskId]).filter(v => v === true).length;
                if (completedCount > 0) {
                    totalXp -= completedCount * 10;
                    if (totalXp < 0) totalXp = 0;
                }
                delete taskCompletions[taskId];
            }

            // Remove task from list
            tasks = tasks.filter(t => t.id !== taskId);

            // Verify XP by recalculating from remaining completions + achievements
            const calculatedXp = recalculateXpFromCompletions() + calculateAchievementXp();
            if (totalXp !== calculatedXp) {
                totalXp = calculatedXp;
            }

            updateLevelDisplay();
            saveData();

            // Skip render if caller will handle it (e.g., deleteAllDays with scroll preservation)
            if (!skipRender) {
                // In Month view, use targeted update for one-time tasks to avoid scroll reset
                if (currentView === 'month' && isOneTimeTask && taskDate) {
                    if (!updateMonthDateSection(taskDate)) {
                        renderCurrentView();
                    }
                } else {
                    renderCurrentView();
                }
            }

            // Close bottom sheet if open
            if (bottomSheet.classList.contains('open')) {
                renderBottomSheetTasks();
            }
        }

        function closeDeleteModal() {
            deleteModal.classList.remove('active');
            pendingDeleteTask = null;
            pendingDeleteContext = null;
        }

        // Toggle task completion in month grid view
        function toggleGridTask(preview) {
            const taskId = preview.dataset.taskId;
            const dateStr = preview.dataset.dateStr;
            const dailyId = preview.dataset.dailyId;

            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            const completionKey = dailyId || taskId;
            const completionDate = task.type === 'onetime' ? task.date : dateStr;
            const wasCompleted = isTaskCompletedForDate(completionKey, completionDate);
            const isNowCompleted = !wasCompleted;

            setTaskCompletedForDate(completionKey, completionDate, isNowCompleted);

            // Update UI
            const checkbox = preview.querySelector('.month-task-checkbox');
            const text = preview.querySelector('.month-task-text');
            checkbox.classList.toggle('checked', isNowCompleted);
            preview.classList.toggle('completed', isNowCompleted);

            // Update XP
            totalXp += isNowCompleted ? 10 : -10;
            if (totalXp < 0) totalXp = 0;
            updateLevelDisplay();

            saveData();

            // Check achievements when completing a task
            if (isNowCompleted) {
                checkAchievements();
            }
        }

        // Handle delete for grid task preview
        function handleGridTaskDelete(preview) {
            const taskId = preview.dataset.taskId;
            const dailyId = preview.dataset.dailyId;
            const dateStr = preview.dataset.dateStr;
            const type = preview.dataset.type;

            if (dailyId || type === 'daily' || type === 'custom') {
                // Recurring task - show modal
                pendingDeleteTask = preview;
                pendingDeleteContext = { taskId, dailyId, dateStr, type };

                const task = tasks.find(t => t.id === taskId);
                const label = getPatternLabel(task?.pattern);

                modalTitle.textContent = 'Delete Repeating Task';
                modalText.textContent = `This task repeats (${label}). How would you like to delete it?`;
                deleteModal.classList.add('active');
            } else {
                // One-time task - delete directly
                deleteTaskCompletely(taskId);
            }
        }

        // Week View
        // Week View - Shows all 7 days
        function renderWeekView() {
            // Render both mobile list and desktop grid (CSS handles visibility)
            renderWeekListView();
            renderWeekGridView();
        }

        // Mobile: Vertical list of all 7 days
        function renderWeekListView() {
            weekList.innerHTML = '';
            const weekDates = getWeekDates(viewingDate);
            const today = new Date();

            weekDates.forEach((date, index) => {
                const isToday = isSameDay(date, today);
                const dateStr = formatDateForInput(date);
                const tasksForDay = getTasksForDate(date);
                const hasNoTasks = tasksForDay.length === 0;

                const section = document.createElement('div');
                section.className = 'week-day-section' + (isToday ? ' today' : '');
                section.dataset.date = dateStr;

                // Header
                const header = document.createElement('div');
                header.className = 'week-day-header';

                const title = document.createElement('div');
                title.className = 'week-day-title';
                title.innerHTML = `
                    <span class="week-day-name">${dayAbbrev[index]}</span>
                    <span class="week-day-num">${date.getDate()}</span>
                `;

                header.appendChild(title);

                // Today badge
                if (isToday) {
                    const badge = document.createElement('span');
                    badge.className = 'week-day-badge';
                    badge.textContent = 'Today';
                    header.appendChild(badge);
                }

                // Task count or empty label
                if (!hasNoTasks) {
                    const countBadge = document.createElement('span');
                    countBadge.className = 'week-task-count';
                    countBadge.textContent = `${tasksForDay.length}`;
                    header.appendChild(countBadge);
                } else if (!isToday) {
                    const emptyLabel = document.createElement('span');
                    emptyLabel.className = 'week-empty-label';
                    emptyLabel.textContent = 'No tasks';
                    header.appendChild(emptyLabel);
                }

                // Add indicator
                const addIndicator = document.createElement('span');
                addIndicator.className = 'week-add-indicator';
                addIndicator.textContent = '+';
                header.appendChild(addIndicator);

                section.appendChild(header);

                // Tasks container
                if (!hasNoTasks) {
                    const tasksContainer = document.createElement('div');
                    tasksContainer.className = 'week-day-tasks';

                    const tasksList = document.createElement('div');
                    tasksList.className = 'day-tasks';

                    tasksForDay.forEach(task => {
                        const taskEl = createTaskElement(task, dateStr);
                        tasksList.appendChild(taskEl);
                    });

                    tasksContainer.appendChild(tasksList);
                    section.appendChild(tasksContainer);
                }

                // Click to add task
                section.addEventListener('click', (e) => {
                    const taskItem = e.target.closest('.task-item');
                    if (taskItem) return;
                    openCreateTaskModal(dateStr);
                });

                weekList.appendChild(section);
            });
        }

        // Desktop: 7-column grid
        function renderWeekGridView() {
            weekGrid.innerHTML = '';
            const weekDates = getWeekDates(viewingDate);
            const today = new Date();

            weekDates.forEach((date, index) => {
                const isToday = isSameDay(date, today);
                const dateStr = formatDateForInput(date);
                const tasksForDay = getTasksForDate(date);

                const dayCol = document.createElement('div');
                dayCol.className = 'week-grid-day' + (isToday ? ' today' : '');
                dayCol.dataset.date = dateStr;

                // Header
                const header = document.createElement('div');
                header.className = 'week-grid-header';
                header.innerHTML = `
                    <div class="week-grid-day-name">${dayAbbrev[index]}</div>
                    <div class="week-grid-day-num">${date.getDate()}</div>
                `;
                dayCol.appendChild(header);

                // Tasks container
                const tasksContainer = document.createElement('div');
                tasksContainer.className = 'week-grid-tasks';

                if (tasksForDay.length === 0) {
                    const emptyDiv = document.createElement('div');
                    emptyDiv.className = 'week-grid-empty';
                    emptyDiv.textContent = 'No tasks';
                    tasksContainer.appendChild(emptyDiv);
                } else {
                    tasksForDay.forEach(task => {
                        const taskEl = createTaskElement(task, dateStr);
                        tasksContainer.appendChild(taskEl);
                    });
                }

                dayCol.appendChild(tasksContainer);

                // Add button
                const addBtn = document.createElement('button');
                addBtn.type = 'button';
                addBtn.className = 'week-grid-add';
                addBtn.textContent = '+';
                addBtn.addEventListener('click', () => {
                    openCreateTaskModal(dateStr);
                });
                dayCol.appendChild(addBtn);

                weekGrid.appendChild(dayCol);
            });
        }

        // Navigate to previous/next week
        function navigateWeek(delta) {
            viewingDate.setDate(viewingDate.getDate() + (delta * 7));
            viewingMonth = viewingDate.getMonth();
            viewingYear = viewingDate.getFullYear();
            updateDateDisplay();
            renderWeekView();
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // Month View
        function renderMonthView() {
            // Render both views (CSS handles which one is visible)
            renderMonthListView();
            renderMonthGridView();
        }

        // Track loaded month range for infinite scroll
        let loadedMonthStart = null;
        let loadedMonthEnd = null;
        let monthScrollObserver = null;
        let isLoadingMonths = false;
        let isInitialMonthRender = true; // Prevent auto-scroll on initial render
        let lastLoadTime = 0; // Debounce rapid scroll loads
        const LOAD_DEBOUNCE_MS = 150; // Minimum time between loads

        // Mobile: Vertical scrollable list - Compact with infinite scroll
        function renderMonthListView() {
            monthList.innerHTML = '';

            // Mark as initial render - prevents auto-scroll loading
            isInitialMonthRender = true;

            // Initialize with 3 months: prev, current, next
            loadedMonthStart = { month: viewingMonth - 1, year: viewingYear };
            loadedMonthEnd = { month: viewingMonth + 1, year: viewingYear };

            // Normalize months
            if (loadedMonthStart.month < 0) {
                loadedMonthStart.month = 11;
                loadedMonthStart.year--;
            }
            if (loadedMonthEnd.month > 11) {
                loadedMonthEnd.month = 0;
                loadedMonthEnd.year++;
            }

            // Render all 3 months
            renderMonthBlock(loadedMonthStart.year, loadedMonthStart.month);
            renderMonthBlock(viewingYear, viewingMonth, true);
            renderMonthBlock(loadedMonthEnd.year, loadedMonthEnd.month);

            // Scroll to current month BEFORE setting up observers
            const currentMonthHeader = monthList.querySelector(`.month-header-separator[data-month="${viewingMonth}"][data-year="${viewingYear}"]`);
            if (currentMonthHeader) {
                currentMonthHeader.scrollIntoView({ behavior: 'auto', block: 'start' });
            }

            // Set up scroll observer AFTER initial scroll, with delay to prevent auto-triggering
            setTimeout(() => {
                setupMonthScrollObserver();
                // Allow infinite scroll after a short delay
                setTimeout(() => {
                    isInitialMonthRender = false;
                }, 500);
            }, 100);
        }

        // Render a single month block with header, dates, and week separators
        function renderMonthBlock(year, month, isCurrent = false) {
            const today = new Date();
            const isCurrentMonth = today.getMonth() === month && today.getFullYear() === year;

            // Month header separator
            const monthHeader = document.createElement('div');
            monthHeader.className = 'month-header-separator' + (isCurrent ? ' current' : '');
            monthHeader.dataset.month = month;
            monthHeader.dataset.year = year;

            const headerTitle = document.createElement('div');
            headerTitle.className = 'month-header-title';
            headerTitle.textContent = `${monthNames[month]} ${year}`;
            monthHeader.appendChild(headerTitle);

            monthList.appendChild(monthHeader);

            // Month block container
            const monthBlock = document.createElement('div');
            monthBlock.className = 'month-block';
            monthBlock.dataset.month = month;
            monthBlock.dataset.year = year;

            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();

            let lastWeekNum = -1;

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const isToday = isCurrentMonth && day === today.getDate();
                const dateStr = formatDateForInput(date);
                const weekdayIndex = getWeekdayFromDate(date);
                const tasksForDay = getTasksForDate(date);
                const hasNoTasks = tasksForDay.length === 0;

                // Calculate week number (week starts on Monday)
                const weekNum = Math.floor((day + getWeekdayFromDate(new Date(year, month, 1)) - 1) / 7);

                // Add week separator
                if (lastWeekNum >= 0 && weekNum > lastWeekNum) {
                    const weekSep = document.createElement('div');
                    weekSep.className = 'week-separator';
                    monthBlock.appendChild(weekSep);
                }
                lastWeekNum = weekNum;

                const section = createDateSection(date, dateStr, day, weekdayIndex, tasksForDay, isToday, hasNoTasks);
                monthBlock.appendChild(section);
            }

            monthList.appendChild(monthBlock);
        }

        // Create a single date section element
        function createDateSection(date, dateStr, day, weekdayIndex, tasksForDay, isToday, hasNoTasks) {
            const section = document.createElement('div');
            section.className = 'month-date-section' + (isToday ? ' today' : '') + (hasNoTasks ? ' empty-section' : '');
            section.dataset.date = dateStr;

            // Compact Header
            const header = document.createElement('div');
            header.className = 'month-date-header';

            const title = document.createElement('div');
            title.className = 'month-date-title';
            title.innerHTML = `
                <span class="month-date-num">${day}</span>
                <span class="month-date-day">${dayAbbrev[weekdayIndex]}</span>
            `;

            header.appendChild(title);

            // For today, show badge
            if (isToday) {
                const badge = document.createElement('span');
                badge.className = 'month-date-badge';
                badge.textContent = 'Today';
                header.appendChild(badge);
            }

            // For empty dates, show "No tasks" label inline
            if (hasNoTasks && !isToday) {
                const emptyLabel = document.createElement('span');
                emptyLabel.className = 'month-empty-label';
                emptyLabel.textContent = 'No tasks';
                header.appendChild(emptyLabel);
            }

            // Task count badge for sections with tasks
            if (!hasNoTasks) {
                const countBadge = document.createElement('span');
                countBadge.className = 'month-task-count';
                countBadge.textContent = `${tasksForDay.length} task${tasksForDay.length > 1 ? 's' : ''}`;
                header.appendChild(countBadge);
            }

            // Add indicator (shows on hover)
            const addIndicator = document.createElement('span');
            addIndicator.className = 'month-add-indicator';
            addIndicator.textContent = '+';
            header.appendChild(addIndicator);

            section.appendChild(header);

            // Add tasks container if there are tasks
            if (!hasNoTasks) {
                const tasksContainer = document.createElement('div');
                tasksContainer.className = 'month-date-tasks';

                const tasksList = document.createElement('div');
                tasksList.className = 'day-tasks';

                tasksForDay.forEach(task => {
                    const taskEl = createTaskElement(task, dateStr);
                    tasksList.appendChild(taskEl);
                });

                tasksContainer.appendChild(tasksList);
                section.appendChild(tasksContainer);
            }

            // Make entire section clickable for adding tasks
            // But don't trigger when clicking on checkboxes, delete buttons, or task items
            section.addEventListener('click', (e) => {
                // Check if click was on an interactive element within a task
                const taskItem = e.target.closest('.task-item');
                if (taskItem) {
                    // Let the task item handle its own click events
                    return;
                }
                // Open task creation modal with this date pre-selected
                openCreateTaskModal(dateStr);
            });

            return section;
        }

        // Set up intersection observer for infinite scroll and header updates
        function setupMonthScrollObserver() {
            // Properly disconnect existing observers
            if (monthScrollObserver) {
                if (monthScrollObserver.header) monthScrollObserver.header.disconnect();
                if (monthScrollObserver.load) monthScrollObserver.load.disconnect();
            }

            // Observer for updating the header date display
            const headerObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting && entry.intersectionRatio > 0.5) {
                        const month = parseInt(entry.target.dataset.month);
                        const year = parseInt(entry.target.dataset.year);
                        if (!isNaN(month) && !isNaN(year)) {
                            viewingMonth = month;
                            viewingYear = year;
                            updateDateDisplay();
                        }
                    }
                });
            }, {
                root: null,
                threshold: 0.5,
                rootMargin: '-100px 0px -50% 0px'
            });

            // Observe all month headers
            monthList.querySelectorAll('.month-header-separator').forEach(header => {
                headerObserver.observe(header);
            });

            // Observer for loading more months
            const loadObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    const now = Date.now();
                    // Skip loading during initial render, if already loading, or if debounce period hasn't passed
                    if (entry.isIntersecting && !isLoadingMonths && !isInitialMonthRender && (now - lastLoadTime > LOAD_DEBOUNCE_MS)) {
                        const block = entry.target;
                        const month = parseInt(block.dataset.month);
                        const year = parseInt(block.dataset.year);

                        if (month === loadedMonthStart.month && year === loadedMonthStart.year) {
                            // Near top - load previous month
                            lastLoadTime = now;
                            loadPreviousMonth();
                        } else if (month === loadedMonthEnd.month && year === loadedMonthEnd.year) {
                            // Near bottom - load next month
                            lastLoadTime = now;
                            loadNextMonth();
                        }
                    }
                });
            }, {
                root: null,
                threshold: 0.1,
                rootMargin: '100px 0px'  // Reduced from 200px to load closer to edge
            });

            // Observe first and last month blocks
            const blocks = monthList.querySelectorAll('.month-block');
            if (blocks.length > 0) {
                loadObserver.observe(blocks[0]);
                loadObserver.observe(blocks[blocks.length - 1]);
            }

            monthScrollObserver = { header: headerObserver, load: loadObserver };
        }

        // Load previous month at the top
        function loadPreviousMonth() {
            isLoadingMonths = true;

            let newMonth = loadedMonthStart.month - 1;
            let newYear = loadedMonthStart.year;
            if (newMonth < 0) {
                newMonth = 11;
                newYear--;
            }

            // Record scroll position before inserting content
            const scrollContainer = document.documentElement;
            const scrollTop = scrollContainer.scrollTop || document.body.scrollTop;
            const oldHeight = monthList.scrollHeight;

            // Create elements for the new month
            const fragment = document.createDocumentFragment();
            const today = new Date();
            const isCurrentMonth = today.getMonth() === newMonth && today.getFullYear() === newYear;

            // Month header
            const monthHeader = document.createElement('div');
            monthHeader.className = 'month-header-separator';
            monthHeader.dataset.month = newMonth;
            monthHeader.dataset.year = newYear;
            const headerTitle = document.createElement('div');
            headerTitle.className = 'month-header-title';
            headerTitle.textContent = `${monthNames[newMonth]} ${newYear}`;
            monthHeader.appendChild(headerTitle);
            fragment.appendChild(monthHeader);

            // Month block
            const monthBlock = document.createElement('div');
            monthBlock.className = 'month-block';
            monthBlock.dataset.month = newMonth;
            monthBlock.dataset.year = newYear;

            const lastDay = new Date(newYear, newMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            let lastWeekNum = -1;

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(newYear, newMonth, day);
                const isToday = isCurrentMonth && day === today.getDate();
                const dateStr = formatDateForInput(date);
                const weekdayIndex = getWeekdayFromDate(date);
                const tasksForDay = getTasksForDate(date);
                const hasNoTasks = tasksForDay.length === 0;

                const weekNum = Math.floor((day + getWeekdayFromDate(new Date(newYear, newMonth, 1)) - 1) / 7);
                if (lastWeekNum >= 0 && weekNum > lastWeekNum) {
                    const weekSep = document.createElement('div');
                    weekSep.className = 'week-separator';
                    monthBlock.appendChild(weekSep);
                }
                lastWeekNum = weekNum;

                const section = createDateSection(date, dateStr, day, weekdayIndex, tasksForDay, isToday, hasNoTasks);
                monthBlock.appendChild(section);
            }

            fragment.appendChild(monthBlock);

            // Insert at beginning
            monthList.insertBefore(fragment, monthList.firstChild);

            // Adjust scroll position to compensate for inserted content
            const newHeight = monthList.scrollHeight;
            const heightDiff = newHeight - oldHeight;
            if (heightDiff > 0) {
                window.scrollTo(0, scrollTop + heightDiff);
            }

            // Update loaded range
            loadedMonthStart = { month: newMonth, year: newYear };

            // Update observers after a brief delay to avoid triggering during scroll adjustment
            setTimeout(() => {
                setupMonthScrollObserver();
                isLoadingMonths = false;
            }, 50);
        }

        // Load next month at the bottom
        function loadNextMonth() {
            isLoadingMonths = true;

            let newMonth = loadedMonthEnd.month + 1;
            let newYear = loadedMonthEnd.year;
            if (newMonth > 11) {
                newMonth = 0;
                newYear++;
            }

            const today = new Date();
            const isCurrentMonth = today.getMonth() === newMonth && today.getFullYear() === newYear;

            // Month header
            const monthHeader = document.createElement('div');
            monthHeader.className = 'month-header-separator';
            monthHeader.dataset.month = newMonth;
            monthHeader.dataset.year = newYear;
            const headerTitle = document.createElement('div');
            headerTitle.className = 'month-header-title';
            headerTitle.textContent = `${monthNames[newMonth]} ${newYear}`;
            monthHeader.appendChild(headerTitle);
            monthList.appendChild(monthHeader);

            // Month block
            const monthBlock = document.createElement('div');
            monthBlock.className = 'month-block';
            monthBlock.dataset.month = newMonth;
            monthBlock.dataset.year = newYear;

            const lastDay = new Date(newYear, newMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            let lastWeekNum = -1;

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(newYear, newMonth, day);
                const isToday = isCurrentMonth && day === today.getDate();
                const dateStr = formatDateForInput(date);
                const weekdayIndex = getWeekdayFromDate(date);
                const tasksForDay = getTasksForDate(date);
                const hasNoTasks = tasksForDay.length === 0;

                const weekNum = Math.floor((day + getWeekdayFromDate(new Date(newYear, newMonth, 1)) - 1) / 7);
                if (lastWeekNum >= 0 && weekNum > lastWeekNum) {
                    const weekSep = document.createElement('div');
                    weekSep.className = 'week-separator';
                    monthBlock.appendChild(weekSep);
                }
                lastWeekNum = weekNum;

                const section = createDateSection(date, dateStr, day, weekdayIndex, tasksForDay, isToday, hasNoTasks);
                monthBlock.appendChild(section);
            }

            monthList.appendChild(monthBlock);

            // Update loaded range
            loadedMonthEnd = { month: newMonth, year: newYear };

            // Update observers
            setupMonthScrollObserver();

            isLoadingMonths = false;
        }

        // Desktop: 7-column grid with task previews
        function renderMonthGridView() {
            monthGrid.innerHTML = '';

            // Weekday headers
            const weekdayHeaders = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            weekdayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.className = 'month-weekday-header';
                header.textContent = day;
                monthGrid.appendChild(header);
            });

            // Get first day and days in month
            const firstDay = new Date(viewingYear, viewingMonth, 1);
            const lastDay = new Date(viewingYear, viewingMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const jsStartDay = firstDay.getDay();
            const startDayOfWeek = jsStartDay === 0 ? 6 : jsStartDay - 1;

            const today = new Date();
            const isCurrentMonth = today.getMonth() === viewingMonth && today.getFullYear() === viewingYear;

            // Empty cells before first day
            for (let i = 0; i < startDayOfWeek; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'month-day empty';
                monthGrid.appendChild(emptyCell);
            }

            // Day cells
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(viewingYear, viewingMonth, day);
                const isToday = isCurrentMonth && day === today.getDate();
                const dateStr = formatDateForInput(date);

                const dayCell = document.createElement('div');
                dayCell.className = 'month-day' + (isToday ? ' today' : '');
                dayCell.dataset.date = dateStr;

                const dayNumber = document.createElement('div');
                dayNumber.className = 'month-day-number';
                dayNumber.textContent = day;
                dayCell.appendChild(dayNumber);

                // Task previews (show up to 2, then "+X more")
                const tasksForDay = getTasksForDate(date);
                const maxVisible = 2;

                if (tasksForDay.length > 0) {
                    const tasksToShow = tasksForDay.slice(0, maxVisible);

                    tasksToShow.forEach(task => {
                        const preview = document.createElement('div');
                        preview.className = 'month-task-preview' + (task.completed ? ' completed' : '');
                        preview.dataset.taskId = task.id;
                        preview.dataset.dateStr = dateStr;
                        if (task.dailyId) preview.dataset.dailyId = task.dailyId;
                        if (task.pattern) preview.dataset.pattern = task.pattern;
                        if (task.type) preview.dataset.type = task.type;

                        // Checkbox
                        const checkbox = document.createElement('span');
                        checkbox.className = 'month-task-checkbox' + (task.completed ? ' checked' : '');

                        // Category indicator
                        const indicator = document.createElement('span');
                        indicator.className = 'category-indicator';
                        indicator.style.background = getCategoryColor(task.category);

                        const text = document.createElement('span');
                        text.className = 'month-task-text';
                        text.textContent = task.name;

                        // Task text click handler - opens notes modal for all tasks
                        text.addEventListener('click', (e) => {
                            e.stopPropagation();
                            openNotesModal(task.id);
                        });

                        // Delete button
                        const deleteBtn = document.createElement('button');
                        deleteBtn.type = 'button';
                        deleteBtn.className = 'month-task-delete';
                        deleteBtn.innerHTML = '&times;';
                        deleteBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            handleGridTaskDelete(preview);
                        });

                        preview.appendChild(checkbox);
                        preview.appendChild(indicator);
                        preview.appendChild(text);
                        preview.appendChild(deleteBtn);

                        // Only checkbox toggles completion
                        checkbox.addEventListener('click', (e) => {
                            e.stopPropagation();
                            toggleGridTask(preview);
                        });

                        dayCell.appendChild(preview);
                    });

                    if (tasksForDay.length > maxVisible) {
                        const moreBtn = document.createElement('div');
                        moreBtn.className = 'month-more-tasks';
                        moreBtn.textContent = `+${tasksForDay.length - maxVisible} more`;
                        moreBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            openBottomSheet(dateStr);
                        });
                        dayCell.appendChild(moreBtn);
                    }
                }

                // Click on empty space to open bottom sheet
                dayCell.addEventListener('click', (e) => {
                    if (!e.target.closest('.month-task-preview')) {
                        openBottomSheet(dateStr);
                    }
                });

                monthGrid.appendChild(dayCell);
            }

            // Fill remaining cells
            const totalCells = startDayOfWeek + daysInMonth;
            const remainingCells = (7 - (totalCells % 7)) % 7;
            for (let i = 0; i < remainingCells; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'month-day empty';
                monthGrid.appendChild(emptyCell);
            }
        }

        // Stats View
        function renderStatsView() {
            const stats = calculateStats();

            // Quick stats
            statTotalCompleted.textContent = stats.totalCompleted;
            statStreak.textContent = stats.streak;
            statCompletionRate.textContent = stats.completionRate + '%';
            statLevel.textContent = getLevel(totalXp);

            // Weekly summary
            weekDateRange.textContent = stats.weekRange;
            weekProgressText.textContent = `${stats.weekCompleted} of ${stats.weekTotal} tasks completed`;
            const weekPercent = stats.weekTotal > 0 ? Math.round((stats.weekCompleted / stats.weekTotal) * 100) : 0;
            weekProgressPercent.textContent = weekPercent + '%';
            weekProgressFill.style.width = weekPercent + '%';

            // Category breakdown
            renderCategoryBreakdown(stats.categoryStats);

            // Achievements
            renderAchievements();
        }

        function calculateStats() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Get current week dates (Monday to Sunday)
            const weekDates = getWeekDates(today);
            const weekStart = weekDates[0];
            const weekEnd = weekDates[6];

            // Calculate total completed (all time)
            let totalCompleted = 0;
            for (const taskId in taskCompletions) {
                totalCompleted += Object.keys(taskCompletions[taskId]).length;
            }

            // Calculate streak (consecutive days with at least 1 completion)
            const streak = calculateStreak();

            // Calculate completion rate
            const completionRate = calculateCompletionRate();

            // Calculate week stats
            const weekStats = calculateWeekStats(weekDates);

            // Format week range
            const startMonth = monthNames[weekStart.getMonth()].slice(0, 3);
            const endMonth = monthNames[weekEnd.getMonth()].slice(0, 3);
            let weekRange;
            if (weekStart.getMonth() === weekEnd.getMonth()) {
                weekRange = `${startMonth} ${weekStart.getDate()} - ${weekEnd.getDate()}`;
            } else {
                weekRange = `${startMonth} ${weekStart.getDate()} - ${endMonth} ${weekEnd.getDate()}`;
            }

            return {
                totalCompleted,
                streak,
                completionRate,
                weekRange,
                weekCompleted: weekStats.completed,
                weekTotal: weekStats.total,
                categoryStats: weekStats.byCategory
            };
        }

        function calculateStreak() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let streak = 0;
            let checkDate = new Date(today);

            // Check if today has any completions
            const todayStr = formatDateForInput(checkDate);
            const todayHasCompletion = hasCompletionOnDate(todayStr);

            // If today has no completion, start checking from yesterday
            if (!todayHasCompletion) {
                checkDate.setDate(checkDate.getDate() - 1);
            }

            // Count consecutive days with completions going backwards
            while (true) {
                const dateStr = formatDateForInput(checkDate);
                if (hasCompletionOnDate(dateStr)) {
                    streak++;
                    checkDate.setDate(checkDate.getDate() - 1);
                } else {
                    break;
                }

                // Safety limit (don't check more than a year back)
                if (streak > 365) break;
            }

            return streak;
        }

        function hasCompletionOnDate(dateStr) {
            for (const taskId in taskCompletions) {
                if (taskCompletions[taskId][dateStr]) {
                    return true;
                }
            }
            return false;
        }

        function calculateCompletionRate() {
            // Get all unique task-date combinations that could have been completed
            let totalPossible = 0;
            let totalCompleted = 0;

            // For each task, count how many times it could have been completed
            // and how many times it was actually completed
            for (const taskId in taskCompletions) {
                const completions = taskCompletions[taskId];
                totalCompleted += Object.keys(completions).length;
            }

            // Count total possible completions based on tasks
            const today = new Date();
            tasks.forEach(task => {
                if (task.type === 'onetime') {
                    totalPossible++;
                } else if (task.type === 'daily') {
                    // Count days from task creation to today (simplified: assume 30 days max)
                    totalPossible += 30;
                } else if (task.type === 'custom') {
                    // Custom tasks: count based on pattern (simplified: 30 days / 7 * days in pattern)
                    const daysCount = task.pattern.split(',').length;
                    totalPossible += Math.round((30 / 7) * daysCount);
                }
            });

            // Simple approach: just use actual completed / total created tasks * 100
            // This gives a more meaningful rate
            if (tasks.length === 0) return 0;

            // Calculate based on completion count vs task count
            const rate = totalCompleted > 0 ? Math.min(Math.round((totalCompleted / Math.max(totalPossible, 1)) * 100), 100) : 0;
            return rate;
        }

        function calculateWeekStats(weekDates) {
            let completed = 0;
            let total = 0;
            const byCategory = {};

            // Category names for display
            const categoryNames = {
                general: 'General',
                health: 'Health & Fitness',
                learning: 'Learning',
                creative: 'Creative',
                wellness: 'Wellness',
                productivity: 'Productivity',
                social: 'Social'
            };

            weekDates.forEach(date => {
                const dateStr = formatDateForInput(date);
                const tasksForDay = getTasksForDate(date);

                tasksForDay.forEach(task => {
                    const category = task.category || 'general';

                    // Initialize category if not exists
                    if (!byCategory[category]) {
                        byCategory[category] = {
                            name: categoryNames[category] || category,
                            color: getCategoryColor(category),
                            total: 0,
                            completed: 0
                        };
                    }

                    total++;
                    byCategory[category].total++;

                    if (task.completed) {
                        completed++;
                        byCategory[category].completed++;
                    }
                });
            });

            return { completed, total, byCategory };
        }

        function renderCategoryBreakdown(categoryStats) {
            categoryBreakdown.innerHTML = '';

            // Convert to array and sort by total tasks (descending)
            const categories = Object.entries(categoryStats)
                .filter(([key, data]) => data.total > 0)
                .sort((a, b) => b[1].total - a[1].total);

            if (categories.length === 0) {
                categoryBreakdown.innerHTML = '<div class="stats-empty">No tasks this week</div>';
                return;
            }

            // Find max task count for proportional bar widths
            const maxTasks = Math.max(...categories.map(([key, data]) => data.total));

            categories.forEach(([key, data]) => {
                // Completion percentage (fill inside the bar)
                const completionPercent = data.total > 0 ? Math.round((data.completed / data.total) * 100) : 0;

                // Proportional bar width based on task count (minimum 40%)
                // This scales dynamically: category with most tasks = 100%, others proportionally smaller
                const barWidthPercent = Math.max(40, Math.round((data.total / maxTasks) * 100));

                const categoryEl = document.createElement('div');
                categoryEl.className = 'category-stat';
                categoryEl.innerHTML = `
                    <div class="category-stat-left">
                        <div class="category-stat-dot" style="background: ${data.color};"></div>
                        <span class="category-stat-name">${data.name}</span>
                    </div>
                    <div class="category-progress-wrapper">
                        <div class="category-progress-container" style="width: ${barWidthPercent}%;">
                            <div class="category-progress-fill" style="width: ${completionPercent}%; background: ${data.color};"></div>
                        </div>
                    </div>
                    <span class="category-stat-count">${data.completed}/${data.total}</span>
                `;

                categoryBreakdown.appendChild(categoryEl);
            });
        }

        // Achievement Functions
        function renderAchievements() {
            const stats = calculateStats();
            const currentStreak = stats.streak;
            const totalCompleted = stats.totalCompleted;

            // Render streak achievements
            renderAchievementGrid(streakAchievementsEl, ACHIEVEMENTS.streak, currentStreak);
            renderAchievementProgress(streakProgressEl, ACHIEVEMENTS.streak, currentStreak, 'days');

            // Render completion achievements
            renderAchievementGrid(completionAchievementsEl, ACHIEVEMENTS.completion, totalCompleted);
            renderAchievementProgress(completionProgressEl, ACHIEVEMENTS.completion, totalCompleted, 'tasks');
        }

        function renderAchievementGrid(container, achievements, currentValue) {
            container.innerHTML = '';

            achievements.forEach(achievement => {
                const isUnlocked = unlockedAchievements[achievement.id];
                const card = document.createElement('div');
                card.className = 'achievement-card' + (isUnlocked ? ' unlocked' : ' locked');

                let extraHtml = '';
                if (isUnlocked) {
                    const date = new Date(isUnlocked.date);
                    extraHtml = `<div class="achievement-date">${formatAchievementDate(date)}</div>`;
                } else {
                    // Show progress for locked achievements
                    const progress = Math.min(currentValue, achievement.threshold);
                    const percentage = Math.min((progress / achievement.threshold) * 100, 100);
                    extraHtml = `
                        <div class="card-progress">
                            <div class="card-progress-text">${progress}/${achievement.threshold}</div>
                            <div class="card-progress-bar">
                                <div class="card-progress-fill" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    `;
                }

                const checkmark = isUnlocked ? '<span class="achievement-check"></span>' : '';
                card.innerHTML = `
                    <div class="achievement-header">
                        ${checkmark}
                        <div class="achievement-name">${achievement.name}</div>
                    </div>
                    <div class="achievement-req">${achievement.requirement}</div>
                    <div class="achievement-xp">+${achievement.xp} XP</div>
                    ${extraHtml}
                `;

                container.appendChild(card);
            });
        }

        function renderAchievementProgress(container, achievements, currentValue, unit) {
            // Find next locked achievement
            let nextAchievement = null;
            for (const achievement of achievements) {
                if (!unlockedAchievements[achievement.id]) {
                    nextAchievement = achievement;
                    break;
                }
            }

            if (!nextAchievement) {
                container.innerHTML = '<span style="color: #737373;">All achievements unlocked!</span>';
                return;
            }

            const progress = Math.min(currentValue, nextAchievement.threshold);
            const percent = Math.round((progress / nextAchievement.threshold) * 100);

            container.innerHTML = `
                <span>Next: ${progress}/${nextAchievement.threshold} ${unit} to ${nextAchievement.name}</span>
                <div class="achievement-progress-bar">
                    <div class="achievement-progress-fill" style="width: ${percent}%;"></div>
                </div>
            `;
        }

        function formatAchievementDate(date) {
            const month = monthNames[date.getMonth()].slice(0, 3);
            return `${month} ${date.getDate()}, ${date.getFullYear()}`;
        }

        function checkAchievements() {
            const stats = calculateStats();
            const currentStreak = stats.streak;
            const totalCompleted = stats.totalCompleted;

            // Check streak achievements
            ACHIEVEMENTS.streak.forEach(achievement => {
                if (!unlockedAchievements[achievement.id] && currentStreak >= achievement.threshold) {
                    unlockAchievement(achievement);
                }
            });

            // Check completion achievements
            ACHIEVEMENTS.completion.forEach(achievement => {
                if (!unlockedAchievements[achievement.id] && totalCompleted >= achievement.threshold) {
                    unlockAchievement(achievement);
                }
            });
        }

        function unlockAchievement(achievement) {
            // Mark as unlocked
            unlockedAchievements[achievement.id] = {
                date: new Date().toISOString()
            };

            // Award XP
            totalXp += achievement.xp;
            updateLevelDisplay();

            // Save data
            saveData();

            // Show celebration
            showCelebration(achievement);

            // Update stats view if visible
            if (currentView === 'stats') {
                renderAchievements();
            }
        }

        function showCelebration(achievement) {
            celebrationName.textContent = achievement.name;
            celebrationReq.textContent = achievement.requirement;
            celebrationXp.textContent = '+' + achievement.xp + ' XP';

            celebrationOverlay.classList.add('active');

            // Auto dismiss after 3 seconds
            const autoDismiss = setTimeout(() => {
                closeCelebration();
            }, 3000);

            // Click to dismiss
            const clickHandler = () => {
                clearTimeout(autoDismiss);
                closeCelebration();
                celebrationOverlay.removeEventListener('click', clickHandler);
            };

            celebrationOverlay.addEventListener('click', clickHandler);
        }

        function closeCelebration() {
            celebrationOverlay.classList.remove('active');
        }

        function showResetConfirmation() {
            confirmOverlay.classList.add('active');
        }
        // Make available for inline onclick
        window.showResetConfirmation = showResetConfirmation;

        function hideResetConfirmation() {
            confirmOverlay.classList.remove('active');
        }
        // Make available for inline onclick
        window.hideResetConfirmation = hideResetConfirmation;

        function resetAchievements() {
            // Calculate XP to remove (sum of all unlocked achievement bonuses)
            let xpToRemove = 0;
            for (const achievementId in unlockedAchievements) {
                // Find the achievement definition
                const allAchievements = [...ACHIEVEMENTS.streak, ...ACHIEVEMENTS.completion];
                const achievement = allAchievements.find(a => a.id === achievementId);
                if (achievement) {
                    xpToRemove += achievement.xp;
                }
            }

            // Clear unlocked achievements (delete all keys to maintain reference)
            for (const key in unlockedAchievements) {
                delete unlockedAchievements[key];
            }

            // Subtract achievement XP from total
            totalXp = Math.max(0, totalXp - xpToRemove);

            // Save to localStorage
            saveData();

            // Update UI
            updateLevelDisplay();

            // Force clear and re-render achievement containers
            streakAchievementsEl.innerHTML = '';
            completionAchievementsEl.innerHTML = '';
            streakProgressEl.innerHTML = '';
            completionProgressEl.innerHTML = '';

            // Re-render achievements with fresh data
            renderAchievements();

            // Close confirmation modal
            hideResetConfirmation();
        }
        // Make available for inline onclick
        window.resetAchievements = resetAchievements;

        // Bottom Sheet
        function openBottomSheet(dateStr) {
            selectedSheetDate = dateStr;
            const date = new Date(dateStr + 'T00:00:00');
            sheetDate.textContent = formatDateForDisplay(date);

            renderBottomSheetTasks();

            bottomSheetOverlay.classList.add('active');
            bottomSheet.classList.add('open');
        }

        function renderBottomSheetTasks() {
            if (!selectedSheetDate) return;

            const date = new Date(selectedSheetDate + 'T00:00:00');
            const tasksForDay = getTasksForDate(date);

            sheetTasks.innerHTML = '';

            if (tasksForDay.length === 0) {
                sheetTasks.innerHTML = '<div class="empty-day">No tasks for this day</div>';
            } else {
                const tasksList = document.createElement('div');
                tasksList.className = 'day-tasks';

                tasksForDay.forEach(task => {
                    const taskEl = createTaskElement(task, selectedSheetDate);
                    tasksList.appendChild(taskEl);
                });

                sheetTasks.appendChild(tasksList);
            }

            // Add button to create task for this date
            const addBtn = document.createElement('button');
            addBtn.type = 'button';
            addBtn.className = 'sheet-add-btn';
            addBtn.innerHTML = '+ Add task for this day';
            addBtn.addEventListener('click', () => {
                const dateToUse = selectedSheetDate;
                closeBottomSheet();
                openCreateTaskModal(dateToUse);
            });
            sheetTasks.appendChild(addBtn);
        }

        function closeBottomSheet() {
            bottomSheetOverlay.classList.remove('active');
            bottomSheet.classList.remove('open');
            selectedSheetDate = null;
        }

        // Task Creation Modal
        function openCreateTaskModal(presetDate = null) {
            createTaskModal.classList.add('active');
            fabButton.classList.add('open');

            // Reset form
            modalTaskInput.value = '';
            modalNotesInput.value = '';
            updateNotesCharCount();
            modalCategorySelect.value = 'general';
            categoryIndicator.style.background = getCategoryColor('general');
            modalTypeSelect.value = 'onetime';
            modalDateInput.value = presetDate || formatDateForInput(viewingDate);
            modalDateField.style.display = 'block';
            modalDayPickerField.style.display = 'none';
            clearModalDayPicker();

            setTimeout(() => modalTaskInput.focus(), 100);
        }

        function closeCreateTaskModal() {
            createTaskModal.classList.remove('active');
            fabButton.classList.remove('open');
            // Clear notes input and reset character count
            modalNotesInput.value = '';
            updateNotesCharCount();
        }

        // Notes Modal Functions
        let currentNotesTaskId = null;

        function openNotesModal(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            currentNotesTaskId = taskId;
            notesModalTitle.textContent = task.name;
            notesModalTextarea.value = task.notes || '';
            notesModal.classList.add('active');

            // Focus textarea after animation
            setTimeout(() => notesModalTextarea.focus(), 100);
        }

        function closeNotesModal() {
            notesModal.classList.remove('active');
            currentNotesTaskId = null;
        }

        function saveNotes() {
            if (!currentNotesTaskId) return;

            const task = tasks.find(t => t.id === currentNotesTaskId);
            if (!task) return;

            const newNotes = notesModalTextarea.value.trim();

            if (newNotes) {
                task.notes = newNotes;
            } else {
                delete task.notes;
            }

            saveData();
            closeNotesModal();
        }

        function updateNotesCharCount() {
            const length = modalNotesInput.value.length;
            const maxLength = 500;
            notesCharCount.textContent = `${length}/${maxLength}`;
        }

        function clearModalDayPicker() {
            modalDayPicker.querySelectorAll('.modal-day-toggle').forEach(btn => {
                btn.classList.remove('selected');
            });
        }

        function getSelectedModalDays() {
            const selected = [];
            modalDayPicker.querySelectorAll('.modal-day-toggle.selected').forEach(btn => {
                selected.push(parseInt(btn.dataset.day));
            });
            return selected.sort((a, b) => a - b);
        }

        function addTask() {
            const taskName = modalTaskInput.value.trim();
            if (!taskName) return;

            const type = modalTypeSelect.value;
            const category = modalCategorySelect.value;
            const notes = modalNotesInput.value.trim();
            const taskId = 'task-' + (++taskIdCounter);

            const newTask = {
                id: taskId,
                name: taskName,
                type: type,
                category: category
            };

            // Add notes only if not empty (keeps data clean)
            if (notes) {
                newTask.notes = notes;
            }

            if (type === 'daily') {
                newTask.dailyId = 'daily-' + (++dailyTaskCounter);
                newTask.pattern = 'daily';
            } else if (type === 'custom') {
                const selectedDays = getSelectedModalDays();
                if (selectedDays.length === 0) {
                    alert('Please select at least one day');
                    return;
                }
                newTask.dailyId = 'daily-' + (++dailyTaskCounter);
                newTask.pattern = selectedDays.join(',');
            } else {
                // One-time
                const date = modalDateInput.value;
                if (!date) {
                    alert('Please select a date');
                    return;
                }
                newTask.date = date;
            }

            tasks.push(newTask);
            saveData();

            closeCreateTaskModal();
            renderCurrentView();

            // Refresh bottom sheet if open
            if (bottomSheet.classList.contains('open')) {
                renderBottomSheetTasks();
            }
        }

        // Swipe Gestures for Day View
        function setupSwipeGestures() {
            // Day view swipe
            dayViewContainer.addEventListener('touchstart', e => {
                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
            }, { passive: true });

            dayViewContainer.addEventListener('touchend', e => {
                touchEndX = e.changedTouches[0].screenX;
                touchEndY = e.changedTouches[0].screenY;
                handleDaySwipe();
            }, { passive: true });

            // Week view swipe
            weekViewContainer.addEventListener('touchstart', e => {
                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
            }, { passive: true });

            weekViewContainer.addEventListener('touchend', e => {
                touchEndX = e.changedTouches[0].screenX;
                touchEndY = e.changedTouches[0].screenY;
                handleWeekSwipe();
            }, { passive: true });
        }

        function handleDaySwipe() {
            const diffX = touchStartX - touchEndX;
            const diffY = touchStartY - touchEndY;

            // Only register horizontal swipes (not vertical scrolling)
            if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > SWIPE_THRESHOLD) {
                if (diffX > 0) {
                    navigateDay(1); // Swipe left  next day
                } else {
                    navigateDay(-1); // Swipe right  previous day
                }
            }
        }

        function handleWeekSwipe() {
            const diffX = touchStartX - touchEndX;
            const diffY = touchStartY - touchEndY;

            // Only register horizontal swipes (not vertical scrolling)
            if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > SWIPE_THRESHOLD) {
                if (diffX > 0) {
                    navigateWeek(1); // Swipe left  next week
                } else {
                    navigateWeek(-1); // Swipe right  previous week
                }
            }
        }

        // Bottom sheet swipe down to close
        function setupBottomSheetGestures() {
            let sheetTouchStartY = 0;

            bottomSheet.addEventListener('touchstart', e => {
                sheetTouchStartY = e.changedTouches[0].screenY;
            }, { passive: true });

            bottomSheet.addEventListener('touchend', e => {
                const sheetTouchEndY = e.changedTouches[0].screenY;
                const diff = sheetTouchEndY - sheetTouchStartY;

                if (diff > 100) {
                    closeBottomSheet();
                }
            }, { passive: true });
        }

        // Data Persistence
        function saveData() {
            const data = {
                tasks: tasks,
                xp: totalXp,
                dailyTaskCounter: dailyTaskCounter,
                taskIdCounter: taskIdCounter,
                completions: taskCompletions,
                achievements: unlockedAchievements
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        function loadData() {
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (!savedData) return;

            try {
                const data = JSON.parse(savedData);

                dailyTaskCounter = data.dailyTaskCounter || 0;
                taskIdCounter = data.taskIdCounter || 0;
                taskCompletions = data.completions || {};
                unlockedAchievements = data.achievements || {};

                // Load tasks - handle migration from old format
                if (data.tasks && Array.isArray(data.tasks)) {
                    // Check if old format (tasks have dayIndex)
                    if (data.tasks.length > 0 && data.tasks[0].dayIndex !== undefined) {
                        // Migrate from old format
                        tasks = migrateOldTasks(data.tasks);
                    } else {
                        tasks = data.tasks;
                    }

                    // Migrate tasks without category (add default "general" category)
                    tasks.forEach(task => {
                        if (!task.category) {
                            task.category = 'general';
                        }
                    });
                }

                // Recalculate XP from completions + achievements
                totalXp = recalculateXpFromCompletions();
                totalXp += calculateAchievementXp();
                updateLevelDisplay();
            } catch (e) {
                console.error('Error loading saved data:', e);
            }
        }

        function calculateAchievementXp() {
            let achievementXp = 0;
            for (const achievementId in unlockedAchievements) {
                // Find achievement by id
                const allAchievements = [...ACHIEVEMENTS.streak, ...ACHIEVEMENTS.completion];
                const achievement = allAchievements.find(a => a.id === achievementId);
                if (achievement) {
                    achievementXp += achievement.xp;
                }
            }
            return achievementXp;
        }

        function migrateOldTasks(oldTasks) {
            const migratedTasks = [];
            const seenDailyIds = new Set();

            oldTasks.forEach(task => {
                // For recurring tasks, only add once
                if (task.dailyId) {
                    if (seenDailyIds.has(task.dailyId)) return;
                    seenDailyIds.add(task.dailyId);

                    migratedTasks.push({
                        id: task.id,
                        name: task.name,
                        type: task.pattern === 'daily' ? 'daily' : 'custom',
                        dailyId: task.dailyId,
                        pattern: task.pattern
                    });
                } else {
                    // One-time task
                    migratedTasks.push({
                        id: task.id,
                        name: task.name,
                        type: 'onetime',
                        date: task.fullDate || formatDateForInput(new Date())
                    });
                }
            });

            return migratedTasks;
        }

        function loadView() {
            const savedView = localStorage.getItem(VIEW_STORAGE_KEY);
            const isMobile = window.innerWidth < 600;

            if (savedView) {
                setView(savedView);
            } else {
                setView(isMobile ? 'day' : 'week');
            }
        }

        // Event Listeners Setup
        function setupEventListeners() {
            // Date navigation
            prevDateBtn.addEventListener('click', () => {
                if (currentView === 'month') {
                    changeMonth(-1);
                } else if (currentView === 'week') {
                    navigateWeek(-1);
                } else {
                    navigateDay(-1);
                }
            });

            nextDateBtn.addEventListener('click', () => {
                if (currentView === 'month') {
                    changeMonth(1);
                } else if (currentView === 'week') {
                    navigateWeek(1);
                } else {
                    navigateDay(1);
                }
            });

            todayBtn.addEventListener('click', goToToday);

            // View toggle
            dayViewBtn.addEventListener('click', () => setView('day'));
            weekViewBtn.addEventListener('click', () => setView('week'));
            monthViewBtn.addEventListener('click', () => setView('month'));
            statsViewBtn.addEventListener('click', () => setView('stats'));

            // FAB
            fabButton.addEventListener('click', () => {
                if (createTaskModal.classList.contains('active')) {
                    closeCreateTaskModal();
                } else {
                    openCreateTaskModal();
                }
            });

            // Modal
            modalCloseBtn.addEventListener('click', closeCreateTaskModal);
            createTaskModal.addEventListener('click', (e) => {
                if (e.target === createTaskModal) {
                    closeCreateTaskModal();
                }
            });

            modalCategorySelect.addEventListener('change', () => {
                const category = modalCategorySelect.value;
                categoryIndicator.style.background = getCategoryColor(category);
            });

            modalTypeSelect.addEventListener('change', () => {
                const type = modalTypeSelect.value;
                modalDateField.style.display = type === 'onetime' ? 'block' : 'none';
                modalDayPickerField.style.display = type === 'custom' ? 'block' : 'none';
            });

            modalDayPicker.querySelectorAll('.modal-day-toggle').forEach(btn => {
                btn.addEventListener('click', () => {
                    btn.classList.toggle('selected');
                });
            });

            modalSubmitBtn.addEventListener('click', addTask);
            modalTaskInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addTask();
            });

            // Notes textarea character count
            modalNotesInput.addEventListener('input', updateNotesCharCount);

            // Notes modal
            notesModalClose.addEventListener('click', closeNotesModal);
            notesModalCancelBtn.addEventListener('click', closeNotesModal);
            notesModalSaveBtn.addEventListener('click', saveNotes);
            notesModal.addEventListener('click', (e) => {
                if (e.target === notesModal) {
                    closeNotesModal();
                }
            });

            // Bottom sheet
            bottomSheetOverlay.addEventListener('click', closeBottomSheet);
            sheetCloseBtn.addEventListener('click', closeBottomSheet);

            // Reset achievements
            if (resetAchievementsBtn) {
                resetAchievementsBtn.addEventListener('click', showResetConfirmation);
            }
            if (confirmCancel) {
                confirmCancel.addEventListener('click', hideResetConfirmation);
            }
            if (confirmReset) {
                confirmReset.addEventListener('click', resetAchievements);
            }
            if (confirmOverlay) {
                confirmOverlay.addEventListener('click', (e) => {
                    if (e.target === confirmOverlay) hideResetConfirmation();
                });
            }

            // Fallback: Event delegation for reset button
            document.addEventListener('click', (e) => {
                if (e.target && (e.target.id === 'resetAchievementsBtn' || e.target.classList.contains('achievements-reset-btn'))) {
                    showResetConfirmation();
                }
            });

            // ESC key to close modals
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (notesModal.classList.contains('active')) {
                        closeNotesModal();
                    } else if (createTaskModal.classList.contains('active')) {
                        closeCreateTaskModal();
                    } else if (deleteModal.classList.contains('active')) {
                        closeDeleteModal();
                    } else if (bottomSheet.classList.contains('open')) {
                        closeBottomSheet();
                    }
                }
            });

            // Swipe gestures
            setupSwipeGestures();
            setupBottomSheetGestures();
        }

        function changeMonth(delta) {
            let targetMonth = viewingMonth + delta;
            let targetYear = viewingYear;

            if (targetMonth > 11) {
                targetMonth = 0;
                targetYear++;
            } else if (targetMonth < 0) {
                targetMonth = 11;
                targetYear--;
            }

            viewingMonth = targetMonth;
            viewingYear = targetYear;
            viewingDate = new Date(viewingYear, viewingMonth, 1);

            // Update display
            updateDateDisplay();

            // Always re-render the grid view (desktop)
            renderMonthGridView();

            // For mobile: Check if target month is already loaded in infinite scroll
            const targetHeader = monthList.querySelector(`.month-header-separator[data-month="${targetMonth}"][data-year="${targetYear}"]`);

            if (targetHeader) {
                // Scroll to it
                targetHeader.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                // Re-render mobile view with new center month
                renderMonthListView();
            }
        }

        // Initialize
        function init() {
            loadData();
            setupEventListeners();
            loadView();
            updateDateDisplay();
        }

        init();
    </script>
</body>
</html>
